---
title: "Manuscript 1 from Fernanda Hansen P. de Moraes Thesis - Cortical folding alterations in humans due to aging and diseases"
author: "Fernanda Hansen Pacheco de Moraes"
date: "1 dec 2021"
output:
  html_document: 
    fig_caption: yes
    fig_width: 8
    number_sections: yes
    theme: paper
    toc: yes
    toc_depth: 6
editor_options: 
  chunk_output_type: inline
---

Description of the procedures and analysis present in Manuscript 1,
**Independent morphological correlates to aging, Mild Cognitive
Impairment, and Alzheimer's Disease**, at the Doctorate Thesis presented
to the Programa de Pós-Graduação em Ciências Médicas at the Instituto
D'Or de Pesquisa e Ensino as a partial requirement to obtain the
Doctorate Degree.

Part of the data used here cannot be shared due to restrictions of the
Ethic Committee. Data can be shared upon reasonable request to the
corresponding author. To fulfill these limitation, we will generate
random data to simulate the results.

Get in touch with us
([fernandahmoraes\@gmail.com](mailto:fernandahmoraes@gmail.com){.email})
in case any help is needed, our aim is to improve the code as needed!

# RMARKDOWN AND R SETUP
```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE,
	cache = TRUE
)
```

```{r working directory}
setwd("D:/GitHub/CorticalFolding_AD_Aging")
```

```{r functions, message=FALSE, warning=FALSE}
## define functions

# test angular coeficinet versus theoretical value
test_coef <- function(reg, coefnum, val){
  co <- coef(summary(reg))
  tstat <- (co[coefnum,1] - val)/co[coefnum,2]
  2 * pt(abs(tstat), reg$df.residual, lower.tail = FALSE)
}

# wrap text
wrapper <- function(x, ...) paste(strwrap(x, ...), collapse = "\n")
```

```{r call packages}
library(readr)
library(tidyverse)
library(lubridate)
library(ggpubr)
library(kableExtra)
library(broom)
library(MASS)
library(cutpointr)
library(ggstatsplot)
library(effects)
library(car)
# library(multcomp)
library(emmeans)
library(compute.es)
library(readxl)

```

```{r} 
# COLOR BLIND PALETTE WITH BLACK
cbbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
cbbPalette2 <- c("#D55E00", "#E69F00", "#56B4E9", "#0072B2", "#CC79A7", "#009E73", "#F0E442")
```

# set seed for random process

```{r}
set.seed(1)
```

```{r import files}
dados_raw <- read_csv("dados_raw.csv")
```

# DATA PREPARATION

```{r create new variables}
# estimate cortical folding variables
dados_raw <- dados_raw %>%
  mutate(
    # create new variables
    logAvgThickness = log10(AvgThickness),
    logTotalArea = log10(TotalArea),
    logExposedArea = log10(ExposedArea),
    localGI = TotalArea / ExposedArea,
    k = sqrt(AvgThickness) * TotalArea / (ExposedArea ^ 1.25),
    K = 1 / 4 * log10(AvgThickness ^ 2)  + log10(TotalArea) - 5 / 4 * log10(ExposedArea),
    S = 3 / 2 * log10(TotalArea) + 3 / 4 * log10(ExposedArea) - 9 /  4 * log10(AvgThickness ^
                                                                                 2) ,
    I = log10(TotalArea) + log10(ExposedArea) + log10(AvgThickness ^ 2),
    c = as.double(ifelse(
      ROI == "hemisphere", NA, 4 * pi / GaussianCurvature
    )),
    TotalArea_corrected = ifelse(ROI == "hemisphere", TotalArea, TotalArea * c),
    ExposedArea_corrected = ifelse(ROI == "hemisphere", ExposedArea, ExposedArea * c),
    logTotalArea_corrected = log10(TotalArea_corrected),
    logExposedArea_corrected = log10(ExposedArea_corrected),
    localGI_corrected = ifelse(
      ROI == "hemisphere",
      TotalArea / ExposedArea,
      TotalArea_corrected / ExposedArea_corrected
    ),
    k_corrected = ifelse(
      ROI == "hemisphere",
      sqrt(AvgThickness) * log10(TotalArea) / (log10(ExposedArea) ^ 1.25),
      sqrt(AvgThickness) * log10(TotalArea_corrected) / (log10(ExposedArea_corrected ^
                                                                 1.25))
    ),
    K_corrected =  ifelse(
      ROI == "hemisphere",
      1 / 4 * log10(AvgThickness ^ 2) + log10(TotalArea) - 5 / 4 * log10(ExposedArea),
      1 / 4 * log10(AvgThickness ^ 2) + log10(TotalArea_corrected) - 5 / 4 * log10(ExposedArea_corrected)
    ),
    I_corrected = ifelse(
      ROI == "hemisphere",
      log10(TotalArea) + log10(ExposedArea) + log10(AvgThickness ^ 2) ,
      log10(TotalArea_corrected) + log10(ExposedArea_corrected) + log10(AvgThickness ^ 2)
    ),
    S_corrected = ifelse(
      ROI == "hemisphere",
      3 / 2 * log10(TotalArea) + 3 / 4 * log10(ExposedArea) - 9 /  4 * log10(AvgThickness ^ 2) ,
      3 / 2 * log10(TotalArea_corrected) + 3 / 4 * log10(ExposedArea_corrected) - 9 /  4 * log10(AvgThickness ^ 2)
    ),
    Knorm = K_corrected / sqrt(1 + (1 / 4) ^ 2 + (5 / 4) ^ 2),
    Snorm = S_corrected / sqrt((3 / 2) ^ 2 + (3 / 4) ^ 2 + (9 / 4) ^ 2),
    Inorm = I_corrected / sqrt(1 ^ 2 + 1 ^ 2 + 1 ^ 1)
  )

```

```{r data cleanup}
dados_all <- dados_raw %>% filter(
    Diagnostic == "CONTROLE" |
      Diagnostic == "CCL" |
      Diagnostic == "ALZ", !is.na(logAvgThickness), ExposedArea != 0 | !is.na(localGI), !is.infinite(logExposedArea)) %>% 
  droplevels()

dados <- dados_all
```

```{r}
# rename diagnostics
dados$Diagnostic[dados$Diagnostic == "CONTROLE"] <- "CTL"
dados$Diagnostic[dados$Diagnostic == "ALZ"] <- "AD"
dados$Diagnostic[dados$Diagnostic == "CCL"] <- "MCI"
dados$Diagnostic <- factor(dados$Diagnostic, levels = c("AD", "MCI","CTL"))

# filter data
dados <- dados %>%
  filter(machine == "Philips-Achieva", # include only subjects acquired at Philips Achieva 3T
                          ESC == 8 | ESC > 8, # include only subjects with 8 years of scholarship or more
                          Session == 1) %>% # use only data from Session 1
  droplevels() # delete factor levels

```

Visual QC exclusion:
```{r}
VisualQC <- read_excel("Verificacao qualidade segmentacao FS Zika e CCD.xlsx", 
    sheet = "AD - IDOR ses 1 long", col_types = c("text", 
        "text", "skip", "skip", "numeric", 
        "skip", "skip", "skip", "skip", "text", 
        "text")) %>%
  dplyr::select(-c(session)) %>%
  mutate(Session = 1)

dados <- full_join(dados, VisualQC) %>%
  filter(Classification == 1 | Classification == 2)
```

# Deaging

```{r deaging}
# define age for deaging
Age.cor = 25

## Avg thickness ----
decay_AvgThickness <-
  filter(
    dados,
    Diagnostic == "CTL",!is.na(TotalArea),!is.nan(TotalArea),!is.infinite(TotalArea)
  ) %>%
  droplevels() %>%
  group_by(ROI) %>%
  do(fit_decay_AvgThickness = tidy(rlm(AvgThickness ~ Age, data = .), conf.int =
                                     TRUE)) %>%
  unnest(cols = c(fit_decay_AvgThickness)) %>%
  filter(term == "Age") %>%
  mutate(c_AvgThickness = estimate,
         std_error_c_AvgThickness = std.error) %>%
  dplyr::select(c(ROI, c_AvgThickness, std_error_c_AvgThickness))

## TotalArea ----
decay_TotalArea <-
  filter(
    dados,
    Diagnostic == "CTL",
    !is.na(TotalArea),
    !is.nan(TotalArea),
    !is.infinite(TotalArea)
  ) %>%
  droplevels() %>%
  group_by(ROI) %>%
  do(fit_decay_TotalArea = tidy(rlm(TotalArea ~ Age, data = .), conf.int =
                                  TRUE)) %>%
  unnest(cols = c(fit_decay_TotalArea)) %>%
  filter(term == "Age") %>%
  mutate(c_TotalArea = estimate,
         std_error_c_TotalArea = std.error) %>%
  dplyr::select(c(ROI, c_TotalArea, std_error_c_TotalArea))

## ExposedArea ----
decay_ExposedArea <-
  filter(
    dados,
    Diagnostic == "CTL",
    !is.na(ExposedArea),
    !is.nan(ExposedArea),
    !is.infinite(ExposedArea)
  ) %>%
  droplevels() %>%
  group_by(ROI) %>%
  do(fit_decay_ExposedArea = tidy(rlm(ExposedArea ~ Age, data = .), conf.int = TRUE)) %>%
  unnest(cols = c(fit_decay_ExposedArea)) %>%
  filter(term == "Age") %>%
  mutate(c_ExposedArea = estimate,
         std_error_c_ExposedArea = std.error) %>%
  dplyr::select(c(ROI, c_ExposedArea, std_error_c_ExposedArea))

## join
dados <- full_join(dados, decay_AvgThickness) %>%
  full_join(decay_TotalArea) %>%
  full_join(decay_ExposedArea) %>%
  mutate(
    AvgThickness_age_decay = AvgThickness - c_AvgThickness * (Age - Age.cor),
    logAvgThickness_age_decay = log10(AvgThickness_age_decay),
    TotalArea_age_decay = TotalArea - c_TotalArea * (Age - Age.cor),
    logTotalArea_age_decay = log10(TotalArea_age_decay),
    ExposedArea_age_decay = ExposedArea - c_ExposedArea * (Age - Age.cor),
    logExposedArea_age_decay = log10(ExposedArea_age_decay),
    localGI_age_decay = TotalArea_age_decay / ExposedArea_age_decay,
    K_age_decay = log10(TotalArea_age_decay) + 1/4*log10(AvgThickness_age_decay^2) - 5/4*log10(ExposedArea_age_decay),
    I_age_decay = log10(TotalArea_age_decay) + log10(ExposedArea_age_decay) + log10(AvgThickness_age_decay^2),
    S_age_decay = 3/2*log10(TotalArea_age_decay) + 3/4*log10(ExposedArea_age_decay) - 9/4*log10(AvgThickness_age_decay^2))

dados$logAvgThickness <- as.double(dados$logAvgThickness)
dados$logExposedArea <- as.double(dados$logExposedArea)
dados$logTotalArea   <- as.double(dados$logTotalArea)

```

```{r}
dados_v1 <- filter(dados, ROI == "F" | ROI == "T" | ROI == "O" | ROI == "P" | ROI == "hemisphere") %>%
  droplevels()

# lobe data
dados_lobos_v1 <- unique(filter(dados, ROI == "F" | ROI == "T" | ROI == "O" | ROI == "P",  !is.na(K_age_decay), SUBJ != "SUBJ211", SUBJ != "SUBJ223")) %>%
  droplevels()

# hemisphere data
dados_hemi_v1 <- unique(filter(dados, ROI == "hemisphere", !is.na(K_age_decay)))
```

```{r eval=FALSE, include=FALSE}
write.csv(dados_v1, "dados_v1.csv")
```

# RESULTS

## Data description

```{r, echo=FALSE, message=FALSE, warning=FALSE}
dados_hemi_v1 %>%
  group_by(Diagnostic) %>%
  summarise(
    N = n_distinct(SUBJ),
    age = paste(signif(mean(Age), 2), "±", signif(sd(Age), 2)),
    age_range = paste(signif(min(Age), 2), "; ", signif(max(Age), 2)),
    ESC = paste(signif(mean(ESC), 2), "±", signif(sd(ESC), 2))
  )

dados_hemi_v1 %>%
  group_by(Diagnostic) %>%
  summarise(
     N = n_distinct(SUBJ),
    AvgThickness = paste(signif(mean(AvgThickness), 2), "±", signif(sd(AvgThickness), 2)),
    TotalArea = paste(signif(mean(TotalArea), 2), "±", signif(sd(TotalArea), 2)),
    ExposedArea = paste(signif(mean(ExposedArea), 2), "±", signif(sd(ExposedArea), 2))
  )

dados_hemi_v1 %>%
  group_by(Diagnostic) %>%
  summarise(
    N = n_distinct(SUBJ),
    k = paste(signif(mean(k), 2), "±", signif(sd(k), 2)),
    K = paste(signif(mean(K), 2), "±", signif(sd(K), 2)),
    S = paste(signif(mean(S), 2), "±", signif(sd(S), 2)),
    I = paste(signif(mean(I), 2), "±", signif(sd(I), 2))
  )

dados_hemi_v1 %>%
  group_by(Diagnostic) %>%
  filter(!is.na(COGNITIVE_INDEX)) %>%
  summarise(
    N = n_distinct(SUBJ),
    COGNITIVE_INDEX = paste(signif(mean(COGNITIVE_INDEX), 2), "±", signif(sd(COGNITIVE_INDEX), 2))
  )

dados_hemi_v1 %>%
  group_by(Diagnostic) %>%
  summarise(
     N = n_distinct(SUBJ),
    `A7/A5` = paste(signif(mean(`A7/A5`), 2), "±", signif(sd(`A7/A5`), 2)),
    `TMT B-A` = paste(signif(mean(`TMT B-A`), 2), "±", signif(sd(`TMT B-A`), 2)),
    `DIGIT SPAN BACK` = paste(signif(mean(`DIGIT SPAN BACK`), 2), "±", signif(sd(`DIGIT SPAN BACK`), 2))
  )

dados_hemi_v1 %>%
  group_by(Diagnostic) %>%
  filter(!is.na(Lipoxina)) %>%
  summarise(
    N = n_distinct(SUBJ),
    Lipoxin = paste(signif(mean(Lipoxina), 2), "±", signif(sd(Lipoxina), 2))
  )

dados_hemi_v1 %>%
  group_by(Diagnostic) %>%
  filter(!is.na(`AB1-40`), !is.na(`AB1-42`), !is.na(TAU)) %>%
  summarise(
    N = n_distinct(SUBJ),
    `AB1-40` = paste(signif(mean(`AB1-40`), 2), "±", signif(sd(`AB1-40`), 2)),
    `AB1-42` = paste(signif(mean(`AB1-42`), 2), "±", signif(sd(`AB1-42`), 2)),
    TAU = paste(signif(mean(TAU), 2), "±", signif(sd(TAU), 2))
  )
```

## Are sex and education (in years) coufounding factors?

### K - Sex
```{r}
ggplot(data = dados_hemi_v1, aes(
  Age,
  K,
  color = Gender,
  fill = Gender,
  alpha = 0.4
)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE) +
  theme_pubr() +
  stat_cor() +
  guides(alpha = "none") +
  labs(x = "Age [years]") +
  scale_fill_manual(values = cbbPalette2) +
  scale_colour_manual(values = cbbPalette2)

# ggsave("fig1_confouders.png", plot = fig1_confouders, width = 14, height = 11, units = "cm", device = "png")

```

```{r}
model1 <- lm(K ~ Diagnostic+Gender, data = dados_hemi_v1)

summary(model1)

plot1 <- ggplot(model1, aes(x = .fitted, y = .resid, alpha = 0.4)) +
  geom_point() +
  stat_smooth(method = "lm", formula = y ~ x + I(x^2), se = FALSE) +
  geom_hline(yintercept = 0) +
  theme_pubr() +
  labs(y = "Pearson residuals", x = "Fitted values") + 
  guides(alpha = "none")

model2 <- lm(K ~ Gender, data = dados_hemi_v1)

summary(model2)
```

```{r}
model3 <- lm(K_age_decay ~ Diagnostic+Gender, data = dados_hemi_v1)

summary(model3)

plot2 <- ggplot(model3, aes(x = .fitted, y = .resid, alpha = 0.4)) +
  geom_point() +
  stat_smooth(method = "lm", formula = y ~ x + I(x^2), se = FALSE) +
  geom_hline(yintercept = 0) +
  theme_pubr() +
  labs(y = "Pearson residuals", x = "Fitted values") + 
  guides(alpha = "none")

plot2

model4 <- lm(K_age_decay ~ Gender, data = dados_hemi_v1)
summary(model4)
```


### K - Education

```{r}
ggplot(data = dados_hemi_v1, aes(
  ESC,
  K,
  color = Diagnostic,
  fill = Diagnostic,
  alpha = 0.4
)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE) +
  theme_pubr() +
  stat_cor() +
  guides(alpha = "none") +
  labs(x = "Age [years]") +
  scale_fill_manual(values = cbbPalette2) +
  scale_colour_manual(values = cbbPalette2)
```

```{r}
# dados_hemi_v1$ESC <- as.factor(dados_hemi_v1$ESC)
```

```{r}
model5 <- lm(K ~ Diagnostic+ESC, data = dados_hemi_v1)

summary(model5)

plot3 <- ggplot(model5, aes(x = .fitted, y = .resid, alpha = 0.4)) +
  geom_point() +
  stat_smooth(method = "lm", formula = y ~ x + I(x^2), se = FALSE) +
  geom_hline(yintercept = 0) +
  theme_pubr() +
  labs(y = "Pearson residuals", x = "Fitted values") + 
  guides(alpha = "none")

plot3

model6 <- lm(K ~ ESC, data = dados_hemi_v1)

summary(model6)

```

```{r}
model7 <- lm(K_age_decay ~ Diagnostic+ESC, data = dados_hemi_v1)

summary(model7)

plot4 <- ggplot(model7, aes(x = .fitted, y = .resid, alpha = 0.4)) +
  geom_point() +
  stat_smooth(method = "lm", formula = y ~ x + I(x^2), se = FALSE) +
  geom_hline(yintercept = 0) +
  theme_pubr() +
  labs(y = "Pearson residuals", x = "Fitted values") + 
  guides(alpha = "none")

plot4

model8 <- lm(K_age_decay ~ ESC, data = dados_hemi_v1)

summary(model8)

```

```{r}
plot <- ggarrange(
    plot1,
    plot2,
    plot3,
    plot4,
    labels = c("A", "B", "C", "D")
  )

plot

ggsave(
  "fig_confouders.png",
  plot = plot,
  dpi = 1200,
  width = 17.8,
  height = 15,
  units = "cm",
  device = "png"
)

```

### Optimal cut-offs
#### K
```{r echo=FALSE}
cpK <-
  cutpointr(
    filter(dados_hemi_v1, Diagnostic == "AD" | Diagnostic == "CTL"),
    K,
    Diagnostic,
    Gender,
    pos_class = "AD",
    neg_class = "CTL",
    method = maximize_boot_metric,
    metric = sum_sens_spec,
    na.rm = TRUE,
    boot_runs = 1000,
    use_midpoints = TRUE
  )
summary(cpK)

cpK_MCI <-
  cutpointr(
    filter(dados_hemi_v1, Diagnostic == "MCI" | Diagnostic == "CTL"),
    K,
    Diagnostic,
    Gender,
    pos_class = "MCI",
    neg_class = "CTL",
    method = maximize_boot_metric,
    metric = sum_sens_spec,
    na.rm = TRUE,
    boot_runs = 1000,
    use_midpoints = TRUE
  )
summary(cpK_MCI)

```

```{r}
roc_K_AD <- cpK$roc_curve[[1]]
roc_K_MCI <- cpK_MCI$roc_curve[[1]]
```

#### log Avg Thickness
```{r}
cpT <-
  cutpointr(
    filter(dados_hemi_v1, Diagnostic == "AD" | Diagnostic == "CTL"),
    logAvgThickness,
    Diagnostic,
    Gender,
    pos_class = "AD",
    neg_class = "CTL",
    method = maximize_boot_metric,
    metric = sum_sens_spec,
    na.rm = TRUE,
    boot_runs = 1000,
    use_midpoints = TRUE
  )
summary(cpT)

cpT_MCI <-
  cutpointr(
    filter(dados_hemi_v1, Diagnostic == "MCI" | Diagnostic == "CTL"),
    logAvgThickness,
    Diagnostic,
    Gender,
    pos_class = "MCI",
    neg_class = "CTL",
    method = maximize_boot_metric,
    metric = sum_sens_spec,
    na.rm = TRUE,
    boot_runs = 1000,
    use_midpoints = TRUE
  )
summary(cpT_MCI)

```

```{r}
roc_T_AD <- cpT$roc_curve[[1]]
roc_T_MCI <- cpT_MCI$roc_curve[[1]]
```

```{r}
lab1 = paste("AD: ACC=", signif(cpK$acc,2),"\nSENS=",signif(cpK$sensitivity,2),"\nSPEC=",signif(cpK$specificity,2),"\nMCI: ACC=", signif(cpK_MCI$acc,2),"\nSENS=",signif(cpK_MCI$sensitivity,2),"\nSPEC=",signif(cpK_MCI$specificity,2))

xrng1 <- range(dados_hemi_v1$K)

cutpoint_a <- ggplot(dados_hemi_v1, aes(x = K, color = Diagnostic, fill = Diagnostic, alpha = 0.4))+
    geom_density() +
    geom_vline(xintercept = cpK$optimal_cutpoint, linetype = "dashed") + 
    geom_vline(xintercept = cpK_MCI$optimal_cutpoint, linetype = "dotted") + 
    theme_pubr() +
    guides(alpha = "none") +
    labs(y = "Density") +
    theme(axis.title = element_text(size = 11),
          axis.text = element_text(size = 10), text = element_text(size = 10)) +
    scale_x_continuous(
        labels = scales::number_format(accuracy = 0.01), limits=c(-0.59,-0.48), breaks = c(-0.58, -0.55, -0.52, -0.49)) +
    scale_fill_manual(values=cbbPalette2) +
    scale_colour_manual(values=cbbPalette2) +
    annotate("text", x = xrng1[1], y = Inf, vjust = 1.1, hjust = 0.95,label = lab1, size = 2)

lab2 = paste("AD: ACC=", signif(cpT$acc,2),"\nSENS=",signif(cpT$sensitivity,2),"\nSPEC=",signif(cpT$specificity,2),"\nMCI: ACC=", signif(cpT_MCI$acc,2),"\nSENS=",signif(cpT_MCI$sensitivity,2),"\nSPEC=",signif(cpT_MCI$specificity,2))

xrng2 <- range(dados_hemi_v1$logAvgThickness)

cutpoint_b <- ggplot(dados_hemi_v1, aes(x = logAvgThickness, color = Diagnostic, fill = Diagnostic, alpha = 0.4))+
    geom_density() +
    geom_vline(xintercept = cpT$optimal_cutpoint, linetype = "dashed") + 
    geom_vline(xintercept = cpT_MCI$optimal_cutpoint, linetype = "dotted") + 
    theme_pubr() +
    guides(alpha = "none") +
    theme(axis.title = element_text(size = 11),
          axis.text = element_text(size = 10), text = element_text(size = 10), legend.position = "none") +
    labs(x = expression('log'[10]*'T'), y = "Density") +
 scale_x_continuous(limits=c(0.32,0.48), n.breaks = 4) +
    scale_fill_manual(values=cbbPalette2) +
    scale_colour_manual(values=cbbPalette2) +
    annotate("text", x = xrng2[1], y = Inf, vjust = 1.1, hjust = 0.95, label = lab2, size = 2)
# cutpoint_b

fig_cutpoint <- ggarrange(cutpoint_a, cutpoint_b, labels = c("A", "B"),  ncol = 1, font.label = list(size = 11), common.legend = TRUE, legend = "top")
```

