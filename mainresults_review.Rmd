---
title: "Manuscript 1 from Fernanda Hansen P. de Moraes Thesis - Cortical folding alterations in humans due to aging and diseases"
author: "Fernanda Hansen Pacheco de Moraes"
date: "1 dec 2021"
output:
  html_document: 
    fig_caption: yes
    fig_width: 8
    number_sections: yes
    theme: paper
    toc: yes
    toc_depth: 6
editor_options: 
  chunk_output_type: inline
---

Description of the procedures and analysis present in Manuscript 1,
**Independent morphological correlates to aging, Mild Cognitive
Impairment, and Alzheimer's Disease**, at the Doctorate Thesis presented
to the Programa de Pós-Graduação em Ciências Médicas at the Instituto
D'Or de Pesquisa e Ensino as a partial requirement to obtain the
Doctorate Degree.

Part of the data used here cannot be shared due to restrictions of the
Ethic Committee. Data can be shared upon reasonable request to the
corresponding author. To fulfill these limitation, we will generate
random data to simulate the results.

Get in touch with us
([fernandahmoraes\@gmail.com](mailto:fernandahmoraes@gmail.com){.email})
in case any help is needed, our aim is to improve the code as needed!

# RMARKDOWN AND R SETUP
```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE,
	cache = TRUE
)
```

```{r working directory}
setwd("D:/GitHub/CorticalFolding_AD_Aging")
```

```{r functions, message=FALSE, warning=FALSE}
## define functions

# test angular coeficinet versus theoretical value
test_coef <- function(reg, coefnum, val){
  co <- coef(summary(reg))
  tstat <- (co[coefnum,1] - val)/co[coefnum,2]
  2 * pt(abs(tstat), reg$df.residual, lower.tail = FALSE)
}

# wrap text
wrapper <- function(x, ...) paste(strwrap(x, ...), collapse = "\n")
```

```{r call packages}
library(readr)
library(readxl)
library(tidyverse)
library(lubridate)
library(ggpubr)
library(kableExtra)
library(broom)
library(MASS)
library(cutpointr)
library(ggstatsplot)
library(effects)
library(car)
# library(multcomp)
library(emmeans)
library(compute.es)
```

```{r} 
# COLOR BLIND PALETTE WITH BLACK
cbbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
cbbPalette2 <- c("#D55E00", "#E69F00", "#56B4E9", "#0072B2", "#CC79A7", "#009E73", "#F0E442")
```

# set seed for random process

```{r}
set.seed(1)
```

```{r import files}
dados_raw <- read_csv("dados_raw.csv")
```

# DATA PREPARATION

```{r create new variables}
# estimate cortical folding variables
dados_raw <- dados_raw %>%
  mutate(
    # create new variables
    logAvgThickness = log10(AvgThickness),
    logTotalArea = log10(TotalArea),
    logExposedArea = log10(ExposedArea),
    localGI = TotalArea / ExposedArea,
    k = sqrt(AvgThickness) * TotalArea / (ExposedArea ^ 1.25),
    K = 1 / 4 * log10(AvgThickness ^ 2)  + log10(TotalArea) - 5 / 4 * log10(ExposedArea),
    S = 3 / 2 * log10(TotalArea) + 3 / 4 * log10(ExposedArea) - 9 /  4 * log10(AvgThickness ^
                                                                                 2) ,
    I = log10(TotalArea) + log10(ExposedArea) + log10(AvgThickness ^ 2),
    c = as.double(ifelse(
      ROI == "hemisphere", NA, 4 * pi / GaussianCurvature
    )),
    TotalArea_corrected = ifelse(ROI == "hemisphere", TotalArea, TotalArea * c),
    ExposedArea_corrected = ifelse(ROI == "hemisphere", ExposedArea, ExposedArea * c),
    logTotalArea_corrected = log10(TotalArea_corrected),
    logExposedArea_corrected = log10(ExposedArea_corrected),
    localGI_corrected = ifelse(
      ROI == "hemisphere",
      TotalArea / ExposedArea,
      TotalArea_corrected / ExposedArea_corrected
    ),
    k_corrected = ifelse(
      ROI == "hemisphere",
      sqrt(AvgThickness) * log10(TotalArea) / (log10(ExposedArea) ^ 1.25),
      sqrt(AvgThickness) * log10(TotalArea_corrected) / (log10(ExposedArea_corrected ^
                                                                 1.25))
    ),
    K_corrected =  ifelse(
      ROI == "hemisphere",
      1 / 4 * log10(AvgThickness ^ 2) + log10(TotalArea) - 5 / 4 * log10(ExposedArea),
      1 / 4 * log10(AvgThickness ^ 2) + log10(TotalArea_corrected) - 5 / 4 * log10(ExposedArea_corrected)
    ),
    I_corrected = ifelse(
      ROI == "hemisphere",
      log10(TotalArea) + log10(ExposedArea) + log10(AvgThickness ^ 2) ,
      log10(TotalArea_corrected) + log10(ExposedArea_corrected) + log10(AvgThickness ^ 2)
    ),
    S_corrected = ifelse(
      ROI == "hemisphere",
      3 / 2 * log10(TotalArea) + 3 / 4 * log10(ExposedArea) - 9 /  4 * log10(AvgThickness ^ 2) ,
      3 / 2 * log10(TotalArea_corrected) + 3 / 4 * log10(ExposedArea_corrected) - 9 /  4 * log10(AvgThickness ^ 2)
    ),
    Knorm = K_corrected / sqrt(1 + (1 / 4) ^ 2 + (5 / 4) ^ 2),
    Snorm = S_corrected / sqrt((3 / 2) ^ 2 + (3 / 4) ^ 2 + (9 / 4) ^ 2),
    Inorm = I_corrected / sqrt(1 ^ 2 + 1 ^ 2 + 1 ^ 1)
  )

# create age intervals
dados_raw$Age_interval <- cut(dados_raw$Age,
                                       breaks = c(0, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80, 85, 90, 95, 100),
                                       right = FALSE,
                                       include.lowest = TRUE)

dados_raw$Age_interval10 <- cut(dados_raw$Age,
                                         breaks = c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100),
                                         right = FALSE,
                                         include.lowest = TRUE)
```

```{r data cleanup}
dados_all <- dados_raw %>% filter(
    Diagnostic == "CONTROLE" |
      Diagnostic == "CCL" |
      Diagnostic == "ALZ", !is.na(logAvgThickness), ExposedArea != 0 | !is.na(localGI), !is.infinite(logExposedArea)) %>% 
  droplevels()

dados <- dados_all
```

```{r}
# rename diagnostics
dados$Diagnostic[dados$Diagnostic == "CONTROLE"] <- "CTL"
dados$Diagnostic[dados$Diagnostic == "ALZ"] <- "AD"
dados$Diagnostic[dados$Diagnostic == "CCL"] <- "MCI"
dados$Diagnostic <- factor(dados$Diagnostic, levels = c("AD", "MCI","CTL"))

# filter data
dados <- dados %>%
  filter(machine == "Philips-Achieva", # include only subjects acquired at Philips Achieva 3T
                          ESC == 8 | ESC > 8, # include only subjects with 8 years of scholarship or more
                          Session == 1) %>% # use only data from Session 1
  droplevels() # delete factor levels
```

Visual QC exclusion:
```{r}
VisualQC <- read_excel("Verificacao qualidade segmentacao FS Zika e CCD.xlsx", 
    sheet = "AD - IDOR ses 1 long", col_types = c("text", 
        "text", "skip", "skip", "numeric", 
        "skip", "skip", "skip", "skip", "text", 
        "text")) %>%
  dplyr::select(-c(session)) %>%
  mutate(Session = 1)

dados <- full_join(dados, VisualQC) %>%
  filter(Classification == 1 | Classification == 2)
```

# Deaging

```{r deaging}
# define age for deaging
Age.cor = 25

## Avg thickness ----
decay_AvgThickness <-
  filter(
    dados,
    Diagnostic == "CTL",!is.na(TotalArea),!is.nan(TotalArea),!is.infinite(TotalArea)
  ) %>%
  droplevels() %>%
  group_by(ROI) %>%
  do(fit_decay_AvgThickness = tidy(rlm(AvgThickness ~ Age, data = .), conf.int =
                                     TRUE)) %>%
  unnest(cols = c(fit_decay_AvgThickness)) %>%
  filter(term == "Age") %>%
  mutate(c_AvgThickness = estimate,
         std_error_c_AvgThickness = std.error) %>%
  dplyr::select(c(ROI, c_AvgThickness, std_error_c_AvgThickness))

## TotalArea ----
decay_TotalArea <-
  filter(
    dados,
    Diagnostic == "CTL",
    !is.na(TotalArea),
    !is.nan(TotalArea),
    !is.infinite(TotalArea)
  ) %>%
  droplevels() %>%
  group_by(ROI) %>%
  do(fit_decay_TotalArea = tidy(rlm(TotalArea ~ Age, data = .), conf.int =
                                  TRUE)) %>%
  unnest(cols = c(fit_decay_TotalArea)) %>%
  filter(term == "Age") %>%
  mutate(c_TotalArea = estimate,
         std_error_c_TotalArea = std.error) %>%
  dplyr::select(c(ROI, c_TotalArea, std_error_c_TotalArea))

## ExposedArea ----
decay_ExposedArea <-
  filter(
    dados,
    Diagnostic == "CTL",
    !is.na(ExposedArea),
    !is.nan(ExposedArea),
    !is.infinite(ExposedArea)
  ) %>%
  droplevels() %>%
  group_by(ROI) %>%
  do(fit_decay_ExposedArea = tidy(rlm(ExposedArea ~ Age, data = .), conf.int = TRUE)) %>%
  unnest(cols = c(fit_decay_ExposedArea)) %>%
  filter(term == "Age") %>%
  mutate(c_ExposedArea = estimate,
         std_error_c_ExposedArea = std.error) %>%
  dplyr::select(c(ROI, c_ExposedArea, std_error_c_ExposedArea))

## join
dados <- full_join(dados, decay_AvgThickness) %>%
  full_join(decay_TotalArea) %>%
  full_join(decay_ExposedArea) %>%
  mutate(
    AvgThickness_age_decay = AvgThickness - c_AvgThickness * (Age - Age.cor),
    logAvgThickness_age_decay = log10(AvgThickness_age_decay),
    TotalArea_age_decay = TotalArea - c_TotalArea * (Age - Age.cor),
    logTotalArea_age_decay = log10(TotalArea_age_decay),
    ExposedArea_age_decay = ExposedArea - c_ExposedArea * (Age - Age.cor),
    logExposedArea_age_decay = log10(ExposedArea_age_decay),
    localGI_age_decay = TotalArea_age_decay / ExposedArea_age_decay,
    K_age_decay = log10(TotalArea_age_decay) + 1/4*log10(AvgThickness_age_decay^2) - 5/4*log10(ExposedArea_age_decay),
    I_age_decay = log10(TotalArea_age_decay) + log10(ExposedArea_age_decay) + log10(AvgThickness_age_decay^2),
    S_age_decay = 3/2*log10(TotalArea_age_decay) + 3/4*log10(ExposedArea_age_decay) - 9/4*log10(AvgThickness_age_decay^2))

dados$logAvgThickness <- as.double(dados$logAvgThickness)
dados$logExposedArea <- as.double(dados$logExposedArea)
dados$logTotalArea   <- as.double(dados$logTotalArea)

```

```{r}
dados_v1 <- filter(dados, ROI == "F" | ROI == "T" | ROI == "O" | ROI == "P" | ROI == "hemisphere") %>%
  droplevels()

# lobe data
dados_lobos_v1 <- unique(filter(dados, ROI == "F" | ROI == "T" | ROI == "O" | ROI == "P",  !is.na(K_age_decay), SUBJ != "SUBJ211", SUBJ != "SUBJ223")) %>%
  droplevels()

# hemisphere data
dados_hemi_v1 <- unique(filter(dados, ROI == "hemisphere", !is.na(K_age_decay)))
```

```{r include=FALSE}
write.csv(dados_v1, "dados_v1.csv")
```

# RESULTS

## Data description

```{r, echo=FALSE, message=FALSE, warning=FALSE}
dados_hemi_v1 %>%
  group_by(Diagnostic) %>%
  summarise(
    N = n_distinct(SUBJ),
    age = paste(signif(mean(Age), 2), "±", signif(sd(Age), 2)),
    age_range = paste(signif(min(Age), 2), "; ", signif(max(Age), 2)),
    ESC = paste(signif(mean(ESC), 2), "±", signif(sd(ESC), 2))
  )

dados_hemi_v1 %>%
  group_by(Diagnostic, Gender) %>%
  summarise(
    N = n_distinct(SUBJ)
  )

dados_hemi_v1 %>%
  group_by(Diagnostic) %>%
  summarise(
     N = n_distinct(SUBJ),
    AvgThickness = paste(signif(mean(AvgThickness), 2), "±", signif(sd(AvgThickness), 2)),
    TotalArea = paste(signif(mean(TotalArea), 2), "±", signif(sd(TotalArea), 2)),
    ExposedArea = paste(signif(mean(ExposedArea), 2), "±", signif(sd(ExposedArea), 2))
  )

dados_hemi_v1 %>%
  group_by(Diagnostic) %>%
  summarise(
    N = n_distinct(SUBJ),
    k = paste(signif(mean(k), 2), "±", signif(sd(k), 2)),
    K = paste(signif(mean(K), 2), "±", signif(sd(K), 2)),
    S = paste(signif(mean(S), 2), "±", signif(sd(S), 2)),
    I = paste(signif(mean(I), 2), "±", signif(sd(I), 2))
  )

dados_hemi_v1 %>%
  group_by(Diagnostic) %>%
  filter(!is.na(COGNITIVE_INDEX)) %>%
  summarise(
    N = n_distinct(SUBJ),
    COGNITIVE_INDEX = paste(signif(mean(COGNITIVE_INDEX), 2), "±", signif(sd(COGNITIVE_INDEX), 2))
  )

dados_hemi_v1 %>%
  group_by(Diagnostic) %>%
  summarise(
     N = n_distinct(SUBJ),
    `A7/A5` = paste(signif(mean(`A7/A5`), 2), "±", signif(sd(`A7/A5`), 2)),
    `TMT B-A` = paste(signif(mean(`TMT B-A`), 2), "±", signif(sd(`TMT B-A`), 2)),
    `DIGIT SPAN BACK` = paste(signif(mean(`DIGIT SPAN BACK`), 2), "±", signif(sd(`DIGIT SPAN BACK`), 2))
  )

dados_hemi_v1 %>%
  group_by(Diagnostic) %>%
  filter(!is.na(Lipoxina)) %>%
  summarise(
    N = n_distinct(SUBJ),
    Lipoxin = paste(signif(mean(Lipoxina), 2), "±", signif(sd(Lipoxina), 2))
  )

dados_hemi_v1 %>%
  group_by(Diagnostic) %>%
  filter(!is.na(`AB1-40`), !is.na(`AB1-42`), !is.na(TAU)) %>%
  summarise(
    N = n_distinct(SUBJ),
    `AB1-40` = paste(signif(mean(`AB1-40`), 2), "±", signif(sd(`AB1-40`), 2)),
    `AB1-42` = paste(signif(mean(`AB1-42`), 2), "±", signif(sd(`AB1-42`), 2)),
    TAU = paste(signif(mean(TAU), 2), "±", signif(sd(TAU), 2))
  )
```

### Stats tests 

#### Age
```{r}
summary(aov(Age ~ Diagnostic, data = dados_hemi_v1))
TukeyHSD(aov(Age ~ Diagnostic, data = dados_hemi_v1))
```

#### Education

```{r}
summary(aov(ESC ~ Diagnostic, data = dados_hemi_v1))
TukeyHSD(aov(ESC ~ Diagnostic, data = dados_hemi_v1))
```

#### T

```{r}
summary(aov(AvgThickness ~ Diagnostic, data = dados_hemi_v1))
TukeyHSD(aov(AvgThickness ~ Diagnostic, data = dados_hemi_v1))
```

#### AT

```{r}
summary(aov(TotalArea ~ Diagnostic, data = dados_hemi_v1))
TukeyHSD(aov(TotalArea ~ Diagnostic, data = dados_hemi_v1))
```

#### AE

```{r}
summary(aov(ExposedArea ~ Diagnostic, data = dados_hemi_v1))
TukeyHSD(aov(ExposedArea ~ Diagnostic, data = dados_hemi_v1))
```

#### k

```{r}
summary(aov(k ~ Diagnostic, data = dados_hemi_v1))
TukeyHSD(aov(k ~ Diagnostic, data = dados_hemi_v1))
```

#### K

```{r}
summary(aov(K ~ Diagnostic, data = dados_hemi_v1))
TukeyHSD(aov(K ~ Diagnostic, data = dados_hemi_v1))
```

#### S

```{r}
summary(aov(S ~ Diagnostic, data = dados_hemi_v1))
TukeyHSD(aov(S ~ Diagnostic, data = dados_hemi_v1))
```

#### I

```{r}
summary(aov(I ~ Diagnostic, data = dados_hemi_v1))
TukeyHSD(aov(I ~ Diagnostic, data = dados_hemi_v1))
```

#### COGNITIVE_INDEX

```{r}
summary(aov(COGNITIVE_INDEX ~ Diagnostic, data = dados_hemi_v1))
TukeyHSD(aov(COGNITIVE_INDEX ~ Diagnostic, data = dados_hemi_v1))
```

#### A7/A5

```{r}
summary(aov(`A7/A5` ~ Diagnostic, data = dados_hemi_v1))
TukeyHSD(aov(`A7/A5` ~ Diagnostic, data = dados_hemi_v1))
```

#### TMT B-A

```{r}
summary(aov(`TMT B-A` ~ Diagnostic, data = dados_hemi_v1))
TukeyHSD(aov(`TMT B-A` ~ Diagnostic, data = dados_hemi_v1))
```

#### Digit Span Backwards

```{r}
summary(aov(`DIGIT SPAN BACK` ~ Diagnostic, data = dados_hemi_v1))
TukeyHSD(aov(`DIGIT SPAN BACK` ~ Diagnostic, data = dados_hemi_v1))
```

#### Lipoxin

```{r}
summary(aov(Lipoxina ~ Diagnostic, data = dados_hemi_v1))
TukeyHSD(aov(Lipoxina ~ Diagnostic, data = dados_hemi_v1))
```

#### AB1-40

```{r}
summary(aov(`AB1-40` ~ Diagnostic, data = dados_hemi_v1))
TukeyHSD(aov(`AB1-40` ~ Diagnostic, data = dados_hemi_v1))
```

#### AB1-42

```{r}
summary(aov(`AB1-42` ~ Diagnostic, data = dados_hemi_v1))
TukeyHSD(aov(`AB1-42` ~ Diagnostic, data = dados_hemi_v1))
```

#### TAU

```{r}
summary(aov(TAU ~ Diagnostic, data = dados_hemi_v1))
TukeyHSD(aov(TAU ~ Diagnostic, data = dados_hemi_v1))
```

## Cortical Folding Model

```{r}
summary(lm(
  1 / 2 * log10(AvgThickness) + log10(TotalArea) ~ log10(ExposedArea),
  data = dados_hemi_v1,
  na.action = na.omit
))

# Displays confidence interval
tidy(lm(
  1 / 2 * log10(AvgThickness) + log10(TotalArea) ~ log10(ExposedArea),
  data = dados_hemi_v1,
  na.action = na.omit
), conf.int = TRUE)

paste(
  "Student's t test comparing slope with theoretical value 1.25. t = ",
  signif(abs(coef(summary(
    lm(
      1 / 2 * log10(AvgThickness) + log10(TotalArea) ~ log10(ExposedArea),
      data = dados_hemi_v1,
      na.action = na.omit
    )
  ))[2, 1] - 1.25) / coef(summary(
    lm(
      1 / 2 * log10(AvgThickness) + log10(TotalArea) ~ log10(ExposedArea),
      data = dados_hemi_v1,
      na.action = na.omit
    )
  ))[2, 2], 3) 
)
paste(
  "Student's t test comparing slope with theoretical value 1.25. p value = ",
  signif(test_coef(
    lm(
      1 / 2 * log10(AvgThickness) + log10(TotalArea) ~ log10(ExposedArea),
      data = dados_hemi_v1,
      na.action = na.omit
    ),
    2,
    1.25
  ),3)
)
```

#### Diagnostic

```{r}

dados_hemi_v1 %>%
  group_by(Diagnostic) %>%
  do(fit_Age = tidy(
    lm(
      1 / 2 * log10(AvgThickness) +  log10(TotalArea) ~  log10(ExposedArea),
      data = .,
      na.action = na.omit
    ),
    conf.int = TRUE
  )) %>%
  unnest(cols = c(Diagnostic))

```

## Correlation within cortical fodling variables and age healthy subjects)

### Slope alpha

```{r}
lm_Age <-
  filter(
    dados_hemi_v1,
    Diagnostic == "CTL",
    Age_interval != "[40,45)",
    Age_interval != "[80,85)"
  ) %>%
  group_by(Age_interval) %>%
  do(fit_Age = tidy(
    lm(
      1 / 2 * log10(AvgThickness) +  log10(TotalArea) ~  log10(ExposedArea),
      data = .,
      na.action = na.omit
    ),
    conf.int = TRUE
  )) %>%
  unnest(cols = c(fit_Age))

lm_Age <- lm_Age %>% mutate(Age_interval = as.double((str_sub(Age_interval,2,3))))

cor <- cor.test(filter(lm_Age, term == "log10(ExposedArea)")$estimate, filter(lm_Age, term == "log10(ExposedArea)")$Age_interval)

cor

res <- res(cor$estimate, n = (cor$parameter + 2) / 2)

res$d
res$l.d
res$u.d
```

### K

```{r}
cor <- cor.test(filter(dados_hemi_v1, Diagnostic == "CTL")$K, filter(dados_hemi_v1, Diagnostic == "CTL")$Age)

cor

res <- res(cor$estimate, n = (cor$parameter + 2) / 2)

res$d
res$l.d
res$u.d
```

#### Diagnostic

```{r}
cor.test(filter(dados_hemi_v1, Diagnostic == "AD")$K, filter(dados_hemi_v1, Diagnostic == "AD")$Age)

cor.test(filter(dados_hemi_v1, Diagnostic == "MCI")$K, filter(dados_hemi_v1, Diagnostic == "MCI")$Age)

```

### S

```{r}
cor <- cor.test(filter(dados_hemi_v1, Diagnostic == "CTL")$S, filter(dados_hemi_v1, Diagnostic == "CTL")$Age)

cor

res <- res(cor$estimate, n = (cor$parameter + 2) / 2)

res$d
res$l.d
res$u.d
```
### I

```{r}
cor <- cor.test(filter(dados_hemi_v1, Diagnostic == "CTL")$I, filter(dados_hemi_v1, Diagnostic == "CTL")$Age)

cor

res <- res(cor$estimate, n = (cor$parameter + 2) / 2)

res$d
res$l.d
res$u.d
```

### data sharing - **FIGURE 1**

```{r}

datafig1 <- dados_hemi_v1 %>%
  dplyr::select(c(Age, Diagnostic, AvgThickness, TotalArea, ExposedArea, K)) %>%
  mutate(x = log10(ExposedArea),
         y = log10(sqrt(AvgThickness) * TotalArea)) %>%
  dplyr::select(c(Age, Diagnostic, x, y, K))
write.csv(datafig1, "datafig1.csv")
```

**FIGURE 1**
```{r}
fig2a <- ggplot(dados_hemi_v1,
                aes(
                  log10(ExposedArea),
                  log10(sqrt(AvgThickness) * TotalArea),
                  color = Diagnostic,
                  fill = Diagnostic,
                  alpha = 0.4
                )) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE) +
  geom_abline(slope = 1.25,
              intercept = coef(lm(
                log10(sqrt(AvgThickness) * TotalArea) ~ log10(ExposedArea),
                data = dados_hemi_v1,
                na.action = na.omit
              ))[1],
              color = "black") +
  labs(x = bquote(log[10]*A[E] ~ "["*mm^2*"]"),
       y = bquote(log[10]*A[T]*sqrt(T) ~ "["*mm^(3/2)*"]")) +
  guides(alpha = "none") +
  theme_pubr() +
  scale_x_continuous(limits = c(4.45, 4.65)) +
  scale_fill_manual(values=cbbPalette2) +
  scale_colour_manual(values=cbbPalette2)
```

```{r}
fig1b <- ggplot(data = dados_hemi_v1, aes(Age, K, color = Diagnostic, fill = Diagnostic, alpha = 0.4)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE) +
  theme_pubr() +
    guides(alpha = "none", color = "none", fill = "none") + 
  labs(x = "Age [years]", y = "K [dimentionless]") +
  scale_fill_manual(values=cbbPalette2) +
  scale_colour_manual(values=cbbPalette2)
```

```{r}
fig1_alt_2 <-
  ggarrange(
    fig2a,
    fig1b,
    labels = c("A", "B"),
    ncol = 2,
    nrow = 1,
    common.legend = TRUE,
    legend = "bottom"
  )

ggsave("Figure1.png", plot = fig1_alt_2, width = 18, height = 9, units = "cm", device = "png")
#ggsave("fig1_alt_2.pdf", plot = fig1_alt_2, dpi=1200, width = 9, height = 11.37, units = "cm", device = "pdf")
```

```{r figure1, fig.cap="\\label{fig:figure1}Age and diagnostic effects in cortical gyrification. We included 77~CTL (blue), 33~MCI (green) and 13~AD (red) subjects. (A) Linear fitting with 95% Confidence Interval (CI) for the model variables in each Diagnostic group, CTL (adjusted R²~=~0.85, p~<~0.0001), MCI (adjusted R²~=~0.88, p~<~0.0001), and AD (adjusted R²~=~0.86, p~<~0.0001). As the severity of the disease increase, the linear tendency is downshifted, with smaller linear intercepts (K). (B) K linear tendency across age with 95% CI for the three diagnostics groups: AD (adjusted R²~=~0.026, p~=~0.21), MCI (adjusted R²~=~0.044, p~=~0.0051), and CTL (adjusted R²~=~0.097, p~<~0.0001)", fig.height=3.54, fig.width=4.48}

fig1_alt_2

```

## Diagnostic discrimination

### K difference

```{r}
aov <- aov(K ~ Diagnostic, data = dados_hemi_v1)
summary(aov)
TukeyHSD(aov)
```

```{r}
aov <- aov(K ~ Diagnostic + Gender + ESC, data = dados_hemi_v1)
summary(aov)
TukeyHSD(aov, which = "Diagnostic")
```

### K is reduced with age, as cortical thickness, total area and exposed area

K decrease with age is shown on Figure 1 B. Cortical Thickness, Total area and Exposed area:

```{r}
T <- ggplot(data = dados_hemi_v1, aes(Age, AvgThickness, color = Diagnostic, fill = Diagnostic, alpha = 0.4)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE) +
  theme_pubr() +
    guides(alpha = "none", color = "none", fill = "none") + 
  labs(x = "Age [years]") +
  scale_fill_manual(values=cbbPalette2) +
  scale_colour_manual(values=cbbPalette2)

AT <- ggplot(data = dados_hemi_v1, aes(Age, TotalArea, color = Diagnostic, fill = Diagnostic, alpha = 0.4)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE) +
  theme_pubr() +
    guides(alpha = "none", color = "none", fill = "none") + 
  labs(x = "Age [years]", y = "Total Area 10^-5 ") +
  scale_y_continuous(
    labels = function(x)
      x / 10000) +
  scale_fill_manual(values=cbbPalette2) +
  scale_colour_manual(values=cbbPalette2)

AE <- ggplot(data = dados_hemi_v1, aes(Age, ExposedArea, color = Diagnostic, fill = Diagnostic, alpha = 0.4)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE) +
  theme_pubr() +
    guides(alpha = "none", color = "none", fill = "none") + 
  labs(x = "Age [years]", y = "Exposed Area 10^-5 ") +
  scale_y_continuous(
    labels = function(x)
      x / 10000) +
  scale_fill_manual(values=cbbPalette2) +
  scale_colour_manual(values=cbbPalette2)

```

```{r}
ggarrange(T, AT, AE, ncol = 1, common.legend = TRUE, legend = "bottom")
```

### Lobes diagnostic discrimination

#### Frontal Lobe

```{r}
aov <- aov(K ~ Diagnostic, data = filter(dados_lobos_v1, ROI == "F"))
summary(aov)
TukeyHSD(aov)
```

#### Occipital Lobe

```{r}
aov <- aov(K ~ Diagnostic, data = filter(dados_lobos_v1, ROI == "O"))
summary(aov)
TukeyHSD(aov)
```

#### Parietal Lobe

```{r}
aov <- aov(K ~ Diagnostic, data = filter(dados_lobos_v1, ROI == "P"))
summary(aov)
TukeyHSD(aov)
```

#### Temporal Lobe

```{r}
aov <- aov(K ~ Diagnostic, data = filter(dados_lobos_v1, ROI == "T"))
summary(aov)
TukeyHSD(aov)
```

### Difference in K between diagnostics decrease with age?

We compared age intervals of 10 years to increase N at each comparison.

#### K

Linear model for visual inspection:

```{r}
b <- lm(K ~ Age * ROI * Diagnostic, data = dados)
summary(b)
aov <- anova(b)
aov

e <- allEffects(b)
e <- as.data.frame(e[[1]])
ggplot(e, aes(
  x = Age,
  y = fit,
  color = Diagnostic,
  ymin = lower,
  ymax = upper
)) +
  geom_pointrange() +
  geom_line() +
  theme_pubr() +
  facet_wrap(ROI ~ .) +
  labs(y = "K") +
  scale_fill_manual(values=cbbPalette2) +
  scale_colour_manual(values=cbbPalette2)
```

Removing MCI for clear plots

```{r}
b <- lm(K ~ Age * ROI * Diagnostic, data = filter(dados, Diagnostic != "MCI"))
summary(b)
aov <- anova(b)
aov

e <- allEffects(b)
e <- as.data.frame(e[[1]])
ggplot(e, aes(
  x = Age,
  y = fit,
  color = Diagnostic,
  ymin = lower,
  ymax = upper
)) +
  geom_pointrange() +
  geom_line() +
  theme_pubr() +
  facet_wrap(ROI ~ .) +
  labs(y = "K") +
  scale_fill_manual(values=cbbPalette2) +
  scale_colour_manual(values=cbbPalette2)
```

#### S
```{r}
b <- lm(S ~ Age * ROI * Diagnostic, data = dados)
summary(b)
aov <- anova(b)
aov

e <- allEffects(b)
e <- as.data.frame(e[[1]])
ggplot(e, aes(
  x = Age,
  y = fit,
  color = Diagnostic,
  ymin = lower,
  ymax = upper
)) +
  geom_pointrange() +
  geom_line() +
  theme_pubr() +
  facet_wrap(ROI ~ .) +
  labs(y = "S") +
  scale_fill_manual(values=cbbPalette2) +
  scale_colour_manual(values=cbbPalette2)
```

#### I

```{r}
b <- lm(I ~ Age * ROI * Diagnostic, data = dados)
summary(b)
aov <- anova(b)
aov

e <- allEffects(b)
e <- as.data.frame(e[[1]])
ggplot(e, aes(
  x = Age,
  y = fit,
  color = Diagnostic,
  ymin = lower,
  ymax = upper
)) +
  geom_pointrange() +
  geom_line() +
  theme_pubr() +
  facet_wrap(ROI ~ .) +
  labs(y = "I") +
  scale_fill_manual(values=cbbPalette2) +
  scale_colour_manual(values=cbbPalette2)
```

### Optimal cut-offs
#### K
```{r echo=FALSE}
cpK <- cutpointr(
        filter(dados_hemi_v1, Diagnostic == "AD" | Diagnostic == "CTL"),
        K,
        Diagnostic,
        pos_class = "AD",
        neg_class = "CTL",
        method = maximize_boot_metric,
        metric = sum_sens_spec,
        na.rm = TRUE,
        boot_runs = 1000,
    use_midpoints = TRUE)
summary(cpK)

write.csv(cpK$data, "datafig2a_AD.csv")

cpK_MCI <-
    cutpointr(
        filter(dados_hemi_v1, Diagnostic == "MCI" | Diagnostic == "CTL"),
        K,
        Diagnostic,
        pos_class = "MCI",
        neg_class = "CTL",
        method = maximize_boot_metric,
        metric = sum_sens_spec,
        na.rm = TRUE,
        boot_runs = 1000,
    use_midpoints = TRUE)
summary(cpK_MCI)

write.csv(cpK_MCI$data, "datafig2a_MCI.csv")

```

```{r}
roc_K_AD <- cpK$roc_curve[[1]]
roc_K_MCI <- cpK_MCI$roc_curve[[1]]

write.csv(cpK$roc_curve[[1]], "datafig2a_rocAD.csv")
write.csv(cpK_MCI$roc_curve[[1]], "datafig2a_rocMCI.csv")

```

#### log Avg Thickness
```{r}
cpT <-
    cutpointr(
        filter(dados_hemi_v1, Diagnostic == "AD" | Diagnostic == "CTL"),
       logAvgThickness,
        Diagnostic,
        pos_class = "AD",
        neg_class = "CTL",
        method = maximize_boot_metric,
        metric = sum_sens_spec,
        na.rm = TRUE,
        boot_runs = 1000,
    use_midpoints = TRUE)
summary(cpT)

write.csv(cpT$data, "datafig2c_AD.csv")

cpT_MCI <-
    cutpointr(
        filter(dados_hemi_v1, Diagnostic == "MCI" | Diagnostic == "CTL"),
       logAvgThickness,
        Diagnostic,
        pos_class = "MCI",
        neg_class = "CTL",
        method = maximize_boot_metric,
        metric = sum_sens_spec,
        na.rm = TRUE,
        boot_runs = 1000,
    use_midpoints = TRUE)
summary(cpT_MCI)

write.csv(cpT_MCI$data, "datafig2c_MCI.csv")

```

```{r}
roc_T_AD <- cpT$roc_curve[[1]]
roc_T_MCI <- cpT_MCI$roc_curve[[1]]

write.csv(cpT$roc_curve[[1]], "datafig2a_rocAD_T.csv")
write.csv(cpT_MCI$roc_curve[[1]], "datafig2a_rocMCI_T.csv")
```

```{r}
lab1 = paste("AD: ACC=", signif(cpK$acc,2),"\nSENS=",signif(cpK$sensitivity,2),"\nSPEC=",signif(cpK$specificity,2),"\nMCI: ACC=", signif(cpK_MCI$acc,2),"\nSENS=",signif(cpK_MCI$sensitivity,2),"\nSPEC=",signif(cpK_MCI$specificity,2))

xrng1 <- range(dados_hemi_v1$K)

cutpoint_a <- ggplot(dados_hemi_v1, aes(x = K, color = Diagnostic, fill = Diagnostic, alpha = 0.4))+
    geom_density() +
    geom_vline(xintercept = cpK$optimal_cutpoint, linetype = "dashed") + 
    geom_vline(xintercept = cpK_MCI$optimal_cutpoint, linetype = "dotted") + 
    theme_pubr() +
    guides(alpha = "none") +
    labs(y = "Density") +
    theme(axis.title = element_text(size = 11),
          axis.text = element_text(size = 10), text = element_text(size = 10)) +
    scale_x_continuous(
        labels = scales::number_format(accuracy = 0.01), limits=c(-0.59,-0.48), breaks = c(-0.58, -0.55, -0.52, -0.49)) +
    scale_fill_manual(values=cbbPalette2) +
    scale_colour_manual(values=cbbPalette2)
# +
#     annotate("text", x = xrng1[1], y = Inf, vjust = 1.1, hjust = 0.95,label = lab1, size = 2)

lab2 = paste("AD: ACC=", signif(cpT$acc,2),"\nSENS=",signif(cpT$sensitivity,2),"\nSPEC=",signif(cpT$specificity,2),"\nMCI: ACC=", signif(cpT_MCI$acc,2),"\nSENS=",signif(cpT_MCI$sensitivity,2),"\nSPEC=",signif(cpT_MCI$specificity,2))

xrng2 <- range(dados_hemi_v1$logAvgThickness)

cutpoint_b <- ggplot(dados_hemi_v1, aes(x = logAvgThickness, color = Diagnostic, fill = Diagnostic, alpha = 0.4))+
    geom_density() +
    geom_vline(xintercept = cpT$optimal_cutpoint, linetype = "dashed") + 
    geom_vline(xintercept = cpT_MCI$optimal_cutpoint, linetype = "dotted") + 
    theme_pubr() +
    guides(alpha = "none") +
    theme(axis.title = element_text(size = 11),
          axis.text = element_text(size = 10), text = element_text(size = 10), legend.position = "none") +
    labs(x = expression('log'[10]*'T'), y = "Density") +
 scale_x_continuous(limits=c(0.32,0.48), n.breaks = 4) +
    scale_fill_manual(values=cbbPalette2) +
    scale_colour_manual(values=cbbPalette2)
# +
#     annotate("text", x = xrng2[1], y = Inf, vjust = 1.1, hjust = 0.95, label = lab2, size = 2)
# cutpoint_b

fig_cutpoint <- ggarrange(cutpoint_a, cutpoint_b, labels = c("A", "B"),  ncol = 1, font.label = list(size = 11), common.legend = TRUE, legend = "top")
```


#### GI
```{r}
cpGI <-
    cutpointr(
        filter(dados_hemi_v1, Diagnostic == "AD" | Diagnostic == "CTL"),
       localGI,
        Diagnostic,
        pos_class = "AD",
        neg_class = "CTL",
        method = maximize_boot_metric,
        metric = sum_sens_spec,
        na.rm = TRUE,
        boot_runs = 1000,
    use_midpoints = TRUE)
summary(cpGI)

cpGI_MCI <-
    cutpointr(
        filter(dados_hemi_v1, Diagnostic == "MCI" | Diagnostic == "CTL"),
       localGI,
        Diagnostic,
        pos_class = "MCI",
        neg_class = "CTL",
        method = maximize_boot_metric,
        metric = sum_sens_spec,
        na.rm = TRUE,
        boot_runs = 1000,
    use_midpoints = TRUE)
summary(cpGI_MCI)
```

#### Deaged
##### K
```{r}
cpK_deaged <-
    cutpointr(
        filter(dados_hemi_v1, Diagnostic == "AD" | Diagnostic == "CTL"),
        K_age_decay,
        Diagnostic,
        pos_class = "AD",
        neg_class = "CTL",
        method = maximize_boot_metric,
        metric = sum_sens_spec,
        na.rm = TRUE,
        boot_runs = 1000,
    use_midpoints = TRUE)
summary(cpK_deaged)
# plot(cpK)

write.csv(cpK_deaged$data, "datafig2b_AD.csv")


cpK_MCI_deaged <-
    cutpointr(
        filter(dados_hemi_v1, Diagnostic == "MCI" | Diagnostic == "CTL"),
        K_age_decay,
        Diagnostic,
        pos_class = "MCI",
        neg_class = "CTL",
        method = maximize_boot_metric,
        metric = sum_sens_spec,
        na.rm = TRUE,
        boot_runs = 1000,
    use_midpoints = TRUE)
summary(cpK_MCI_deaged)
# plot(cpK_MCI)


write.csv(cpK_MCI_deaged$data, "datafig2b_MCI.csv")

```

##### log Avg Thickness

```{r}
cpT_deaged <-
    cutpointr(
        filter(dados_hemi_v1, Diagnostic == "AD" | Diagnostic == "CTL"),
       logAvgThickness_age_decay,
        Diagnostic,
        pos_class = "AD",
        neg_class = "CTL",
        method = maximize_boot_metric,
        metric = sum_sens_spec,
        na.rm = TRUE,
        boot_runs = 1000,
    use_midpoints = TRUE)
summary(cpT_deaged)

write.csv(cpT_deaged$data, "datafig2d_AD.csv")

cpT_MCI_deaged <-
    cutpointr(
        filter(dados_hemi_v1, Diagnostic == "MCI" | Diagnostic == "CTL"),
       logAvgThickness_age_decay,
        Diagnostic,
        pos_class = "MCI",
        neg_class = "CTL",
        method = maximize_boot_metric,
        metric = sum_sens_spec,
        na.rm = TRUE,
        boot_runs = 1000,
    use_midpoints = TRUE)
summary(cpT_MCI_deaged)

write.csv(cpT_MCI_deaged$data, "datafig2d_MCI.csv")
```

##### GI
```{r}
cpGI_deaged <-
    cutpointr(
        filter(dados_hemi_v1, Diagnostic == "AD" | Diagnostic == "CTL"),
        localGI_age_decay,
        Diagnostic,
        pos_class = "AD",
        neg_class = "CTL",
        method = maximize_boot_metric,
        metric = sum_sens_spec,
        na.rm = TRUE,
        boot_runs = 1000,
    use_midpoints = TRUE)
summary(cpGI_deaged)
# plot(cpK)

cpGI_MCI_deaged <-
    cutpointr(
        filter(dados_hemi_v1, Diagnostic == "MCI" | Diagnostic == "CTL"),
        localGI_age_decay,
        Diagnostic,
        pos_class = "MCI",
        neg_class = "CTL",
        method = maximize_boot_metric,
        metric = sum_sens_spec,
        na.rm = TRUE,
        boot_runs = 1000,
    use_midpoints = TRUE)
summary(cpGI_MCI_deaged)
# plot(cpK_MCI)

```

```{r}
lab3 = paste("AD: ACC=", signif(cpK_deaged$acc,2),"\nSENS=",signif(cpK_deaged$sensitivity,2),"\nSPEC=",signif(cpK_deaged$specificity,2),"\nMCI: ACC=", signif(cpK_MCI_deaged$acc,2),"\nSENS=",signif(cpK_MCI_deaged$sensitivity,2),"\nSPEC=",signif(cpK_MCI_deaged$specificity,2))

cutpoint_a_deaged <- ggplot(dados_hemi_v1, aes(x = K_age_decay, color = Diagnostic, fill = Diagnostic, alpha = 0.4))+
  geom_density() +
  geom_vline(data = cpK_deaged, aes(xintercept = optimal_cutpoint), linetype = "dashed") + 
    geom_vline(data = cpK_MCI_deaged, aes(xintercept = optimal_cutpoint), linetype = "dotted") + 
  theme_pubr() +
  guides(alpha = "none", linetype = "none") +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10)) +
  labs(x = "K (After age correction)", y = "Density") +
  scale_x_continuous(
              labels = scales::number_format(accuracy = 0.01), limits=c(-0.59,-0.48), breaks = c(-0.58, -0.55, -0.52, -0.49)) +
  scale_fill_manual(values=cbbPalette2) +
  scale_colour_manual(values=cbbPalette2)
# +
#     annotate("text", x = xrng1[1], y = Inf, vjust = 1.1, hjust = 0.95, label = lab3, size = 2)
# cutpoint_a_deaged

lab4 = paste("AD: ACC=", signif(cpT_deaged$acc,2),"\nSENS=",signif(cpT_deaged$sensitivity,2),"\nSPEC=",signif(cpT_deaged$specificity,2),"\nMCI: ACC=", signif(cpT_MCI_deaged$acc,2),"\nSENS=",signif(cpT_MCI_deaged$sensitivity,2),"\nSPEC=",signif(cpT_MCI_deaged$specificity,2))

cutpoint_b_deaged <- ggplot(dados_hemi_v1, aes(x = logAvgThickness_age_decay, color = Diagnostic, fill = Diagnostic, alpha = 0.4))+
  geom_density() +
  geom_vline(data = cpT_deaged, aes(xintercept = optimal_cutpoint), linetype = "dashed") + 
  geom_vline(data = cpT_MCI_deaged, aes(xintercept = optimal_cutpoint), linetype = "dotted") + 
  theme_pubr() +
  guides(alpha = "none", linetype = "none") +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), legend.position = "none") +
  labs(x = expression('log'[10]*'T '*('After age correction')), y = "Density") +
  scale_x_continuous(limits=c(0.32,0.48), n.breaks = 4) +
  scale_fill_manual(values=cbbPalette2) +
  scale_colour_manual(values=cbbPalette2)
# +
# annotate("text", x = xrng2[1], y = Inf, vjust = 1.1, hjust = 0.95, label = lab4, size = 2)

```

### data sharing - **FIGURE 2**

```{r}

datafig2 <- dados_hemi_v1 %>%
  dplyr::select(c(Age, Diagnostic, AvgThickness, TotalArea, ExposedArea, K)) %>%
  mutate(x = log10(ExposedArea),
         y = log10(sqrt(AvgThickness) * TotalArea)) %>%
  dplyr::select(c(Age, Diagnostic, x, y, K))
write.csv(datafig1, "datafig1.csv")
```

**FIGURE 2**

```{r}
fig_cutpoint_deaged_alt <- ggarrange(cutpoint_a, cutpoint_b, cutpoint_a_deaged,  cutpoint_b_deaged, labels = c("A", "B", "C", "D"),  ncol = 2, nrow = 2, font.label = list(size = 11), common.legend = TRUE, legend = "bottom") + 
  theme(plot.background = element_rect(fill="white", color = NA))

ggsave("Figure2_nocomments.png", plot = fig_cutpoint_deaged_alt, width = 18, height = 11, units = "cm", device = "png")
# ggsave("fig_cutpoint_deaged_alt.pdf", plot = fig_cutpoint_deaged_alt, dpi=1200, width = 9, height = 22, units = "cm", device = "pdf")
```

```{r figure2, fig.cap="\\label{fig:figure2}Optimal cut-off (maximum sensitivity + specificity) for K and Average Cortical Thickness including results with removed age effect (age correction). AD in red (N = 13), MCI in green (N = 33), and Cognitive Unimpaired Controls (CTL) in blue (N = 77). The dashed line represents optimal cut-off to discriminate AD and CTL, and the dotted line represents optimal cut-off to discriminate MCI and CTL. ACC - accuracy, SPEC - specificity, and SENS - sensibility. (A) The optimal cut-off for the CTL-AD contrast is -0.54 and CTL-MCI, -0.53. (B) The optimal cut-off for CTL-AD = -0.52 and CTL-MCI = -0.51. (C) The optimal cut-off for CTL-AD = 0.39 mm and CTL-MCI = 0.40 mm. (D) The optimal cut-off for CTL-AD = 0.43 mm and CTL-MCI = 0.44 mm.", fig.height=8.66, fig.width=3.54}

fig_cutpoint_deaged_alt
```

#### Lobes (age corrected)

**Table 1**

```{r}
cpK <-
    cutpointr(
        filter(dados_lobos_v1, Diagnostic == "AD" | Diagnostic == "CTL"),
        K_age_decay,
        Diagnostic,
        ROI,
        pos_class = "AD",
        neg_class = "CTL",
        method = maximize_boot_metric,
        metric = sum_sens_spec,
        na.rm = TRUE,
        boot_runs = 1000,
    use_midpoints = TRUE)
summary(cpK)

cpK_MCI <-
    cutpointr(
        filter(dados_lobos_v1, Diagnostic == "MCI" | Diagnostic == "CTL"),
        K_age_decay,
        Diagnostic,
        ROI,
        pos_class = "MCI",
        neg_class = "CTL",
        method = maximize_boot_metric,
        metric = sum_sens_spec,
        na.rm = TRUE,
        boot_runs = 1000,
    use_midpoints = TRUE)
summary(cpK_MCI)

```

### Aging and pathological morphology alterations

Age groups:
```{r}
dados_hemi_v1_agegroups <- dados_hemi_v1 %>%
  mutate(Age.group = ifelse(
    Age > 75,
    "76-86",
    ifelse((Age < 75 | Age == 75 & Age > 65 | Age == 65),
           "66-75",
           "")))

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
dados_hemi_v1_agegroups %>%
  group_by(Diagnostic, Age.group) %>%
  summarise(
    N = n_distinct(SUBJ),
    age = paste(signif(mean(Age), 2), "±", signif(sd(Age), 2)),
    age_range = paste(signif(min(Age), 2), "; ", signif(max(Age), 2)),
    ESC = paste(signif(mean(ESC), 2), "±", signif(sd(ESC), 2))
  ) %>%
  kable(digits = 2) %>%
  kable_styling()
```

#### K
```{r}
summary(aov(K ~ Diagnostic*Age.group, data = dados_hemi_v1_agegroups))
TukeyHSD(aov(K ~ Diagnostic*Age.group, data = dados_hemi_v1_agegroups))

boxplot(K ~ Diagnostic*Age.group,
data = dados_hemi_v1_agegroups,
col = "steelblue",
border = "black", 
las = 2 #make x-axis labels perpendicular
)
```

#### S
```{r}
summary(aov(S ~ Diagnostic*Age.group, data = dados_hemi_v1_agegroups))
TukeyHSD(aov(S ~ Diagnostic*Age.group, data = dados_hemi_v1_agegroups))

boxplot(S ~ Diagnostic*Age.group,
data = dados_hemi_v1_agegroups,
col = "steelblue",
border = "black", 
las = 2 #make x-axis labels perpendicular
)
```

#### I
```{r}
summary(aov(I ~ Diagnostic*Age.group, data = dados_hemi_v1_agegroups))
TukeyHSD(aov(I ~ Diagnostic*Age.group, data = dados_hemi_v1_agegroups))

boxplot(I ~ Diagnostic*Age.group,
data = dados_hemi_v1_agegroups,
col = "steelblue",
border = "black", 
las = 2 #make x-axis labels perpendicular
)
```

**Figure 3**

```{r}
mean_K_I_S <-
  dados_hemi_v1 %>% group_by(Diagnostic) %>% summarise(
    mean.K = mean(Knorm, na.rm = TRUE),
    SD_K = sd(Knorm, na.rm = TRUE),
    mean.I = mean(Inorm, na.rm = TRUE),
    SD_I = sd(Inorm, na.rm = TRUE),
    mean.S = mean(Snorm, na.rm = TRUE),
    SD_S = sd(Snorm, na.rm = TRUE),
    N_SUBJ = n_distinct(SUBJ)
    )
```

```{r K I S}
fig3a <- ggplot(mean_K_I_S, aes(x = mean.K, y = mean.S, color = Diagnostic)) +
  geom_point() +
  geom_line(group =1, color = "gray") +
  theme_pubr() +
  # theme(axis.title = element_text(size = 11),
  #   axis.text = element_text(size = 10), text = element_text(size = 10)) +
  scale_fill_manual(values=cbbPalette2) +
  scale_colour_manual(values=cbbPalette2)

fig3a

```

```{r}
ggplot(mean_K_I_S, aes(x = mean.K, y = mean.S, color = Diagnostic)) +
  geom_point() +
  geom_line(group =1, color = "gray") +
  geom_errorbar(aes(ymin = mean.S - SD_S, ymax = mean.S + SD_S))  +
  geom_errorbarh(aes(xmin = mean.K - SD_K, xmax = mean.K + SD_K))  +
  geom_point(data = dados_hemi_v1,aes(x = Knorm, y = Snorm, color = Diagnostic), alpha = 0.2) +
  theme_pubr() +
  # theme(axis.title = element_text(size = 11),
  #   axis.text = element_text(size = 10), text = element_text(size = 10)) +
  scale_fill_manual(values=cbbPalette2) +
  scale_colour_manual(values=cbbPalette2)

```

```{r}
fig3c <- ggplot(mean_K_I_S, aes(x = mean.K, y = mean.I, color = Diagnostic)) +
  geom_point() +
  geom_line(group =1, color = "gray") +
  theme_pubr() +
  # theme(axis.title = element_text(size = 11),
  #   axis.text = element_text(size = 10), text = element_text(size = 10)) +
  scale_fill_manual(values=cbbPalette2) +
  scale_colour_manual(values=cbbPalette2)

fig3c
```

```{r}
ggplot(mean_K_I_S, aes(x = mean.K, y = mean.I, color = Diagnostic)) +
  geom_point() +
  geom_line(group =1, color = "gray") +
    geom_errorbar(aes(ymin = mean.I - SD_I, ymax = mean.I + SD_I))  +
  geom_errorbarh(aes(xmin = mean.K - SD_K, xmax = mean.K + SD_K))  +
  geom_point(data = dados_hemi_v1, aes(x = Knorm, y = Inorm, color = Diagnostic), alpha = 0.2) +
  theme_pubr() +
  # theme(axis.title = element_text(size = 11),
  #   axis.text = element_text(size = 10), text = element_text(size = 10)) +
  scale_fill_manual(values=cbbPalette2) +
  scale_colour_manual(values=cbbPalette2)

```

```{r}
mean_K_I_S_agegroups <-
  filter(dados_hemi_v1_agegroups) %>% group_by(Diagnostic, Age.group) %>% summarise(
    mean.T = mean(logAvgThickness, na.rm = TRUE),
    SD_T = sd(logAvgThickness, na.rm = TRUE),
    mean.K = mean(Knorm, na.rm = TRUE),
    SD_K = sd(Knorm, na.rm = TRUE),
    mean.I = mean(Inorm, na.rm = TRUE),
    SD_I = sd(Inorm, na.rm = TRUE),
    mean.S = mean(Snorm, na.rm = TRUE),
    SD_S = sd(Snorm, na.rm = TRUE),
    N_SUBJ = n_distinct(SUBJ)
  )

```

```{r}
fig3b <- ggplot(mean_K_I_S_agegroups, aes(x = mean.K, y = mean.S, color = Diagnostic, shape = Age.group ))+
    geom_point() +
    geom_line(aes(group = Diagnostic)) +
    #geom_text(aes(label=Age.group), nudge_y = 0.1, size =3)+
    theme_pubr() + 
  # guides(color = "none") + 
    labs(shape = "Age", x = "K (normalized)", y = "S (normalized)") +
    # theme(axis.title = element_text(size = 11),
    #       axis.text = element_text(size = 10), text = element_text(size = 10)) +
  scale_fill_manual(values=cbbPalette2) +
  scale_colour_manual(values=cbbPalette2) +
  theme(legend.position="bottom", legend.box="vertical", legend.margin=margin())

fig3b

```

```{r}
fig3b_Alt <- ggplot(mean_K_I_S_agegroups, aes(x = mean.K, y = mean.S, color = Diagnostic, shape = Age.group))+
    geom_point() +
    geom_line(aes(group = Diagnostic)) +
  geom_errorbar(aes(ymin = mean.S - SD_S, ymax = mean.S + SD_S))  +
  geom_errorbarh(aes(xmin = mean.K - SD_K, xmax = mean.K + SD_K))  +
  geom_point(data = dados_hemi_v1_agegroups, aes(x = Knorm, y = Snorm, color = Diagnostic, shape = Age.group), alpha = 0.2) +
    #geom_text(aes(label=Age.group), nudge_y = 0.1, size =3)+
    theme_pubr() + 
  # guides(color = "none") + 
    labs(shape = "Age", x = "K (normalized)", y = "S (normalized)") +
    # theme(axis.title = element_text(size = 11),
    #       axis.text = element_text(size = 10), text = element_text(size = 10)) +
  scale_fill_manual(values=cbbPalette2) +
  scale_colour_manual(values=cbbPalette2) +
  theme(legend.position="bottom", legend.box="vertical", legend.margin=margin())

fig3b_Alt
```

```{r}
fig3d <- ggplot(mean_K_I_S_agegroups, aes(x = mean.K, y = mean.I, color = Diagnostic, shape = Age.group ))+
    geom_point() +
    geom_line(aes(group = Diagnostic)) +
    #geom_text(aes(label=Age.group), nudge_y = 0.1, size =3)+
    theme_pubr() +
  # guides(color = "none") + 
    labs(shape = "Age", x = "K (normalized)", y = "I (normalized)")  +
    # theme(axis.title = element_text(size = 11),
    #       axis.text = element_text(size = 10), text = element_text(size = 10)) +
  scale_fill_manual(values=cbbPalette2) +
  scale_colour_manual(values=cbbPalette2) +
  theme(legend.position="bottom" , legend.box="vertical", legend.margin=margin())

fig3d

```

```{r}
fig3d_Alt <- ggplot(mean_K_I_S_agegroups, aes(x = mean.K, y = mean.I, color = Diagnostic, shape = Age.group))+
    geom_point() +
    geom_line(aes(group = Diagnostic)) +
    geom_errorbar(aes(ymin = mean.I - SD_I, ymax = mean.I + SD_I))  +
  geom_errorbarh(aes(xmin = mean.K - SD_K, xmax = mean.K + SD_K))  +
  geom_point(data = dados_hemi_v1_agegroups, aes(x = Knorm, y = Inorm, color = Diagnostic, shape = Age.group), alpha = 0.2) +
    #geom_text(aes(label=Age.group), nudge_y = 0.1, size =3)+
    theme_pubr() + 
  # guides(color = "none") + 
    labs(shape = "Age", x = "K (normalized)", y = "I (normalized)") +
    # theme(axis.title = element_text(size = 11),
    #       axis.text = element_text(size = 10), text = element_text(size = 10)) +
  scale_fill_manual(values=cbbPalette2) +
  scale_colour_manual(values=cbbPalette2) +
  theme(legend.position="bottom", legend.box="vertical", legend.margin=margin())
fig3d_Alt
```

```{r}
fig3s <- ggarrange(fig3b, fig3d, labels = c("A", "B"), nrow=2, font.label = list(size = 11), common.legend = TRUE, legend = "bottom")

#fig3s <- ggarrange(fig3a, fig3b,fig3c, fig3d, labels = c("A", "B","C","D"), nrow=2, ncol=2, font.label = list(size = 11))

# ("fig3s.pdf",fig3s, width = 9, height = 17.1, units = "cm", device = "pdf")

```


```{r}
fig3s_Alt <- ggarrange(fig3b_Alt, fig3d_Alt, labels = c("A", "B"),ncol = 2, nrow=1, font.label = list(size = 11), common.legend = TRUE, legend = "bottom")

fig3s_Alt

#fig3s <- ggarrange(fig3a, fig3b,fig3c, fig3d, labels = c("A", "B","C","D"), nrow=2, ncol=2, font.label = list(size = 11))

ggsave("Figure3.png",fig3s_Alt, width = 18, height = 9, units = "cm", device = "png")
# ggsave("fig3s.pdf",fig3s, dpi = 1200, width = 18, height = 17.1, units = "cm", device = "pdf")
```

```{r figure3, fig.cap="\\label{fig:figure3}Morphological trajectory traced across the normalized independent components K, S,and I. We normalized the variable to the unity vectors providing comparable scale for the differences in both axes. (A, C) CTL as Control (blue, N~=~77) and the reference, MCI as Mild Cognitive Impairment (green, N~=~33) and AD for Alzheimer’s Disease (red, N~=~17). (B, D) Groups were divide in two subgroups, subjects with age between 65 and 75 years (circle, CTL N~=~67, MCI N~=~24, AD N~=~4) old and subjects with ages between 76 and 85 years old (triangle, CTL N~=~10, MCI N~=~9, AD N~=~9).", fig.height=6.73, fig.width=3.54 }
fig3s
```

### FIGURE 3 with age intervals

```{r, echo=FALSE, message=FALSE, warning=FALSE}
dados_hemi_v1 %>%
  group_by(Diagnostic, Age_interval10) %>%
  summarise(
    N = n_distinct(SUBJ),
    age = paste(signif(mean(Age), 2), "±", signif(sd(Age), 2)),
    age_range = paste(signif(min(Age), 2), "; ", signif(max(Age), 2)),
    ESC = paste(signif(mean(ESC), 2), "±", signif(sd(ESC), 2))
  ) %>%
  kable(digits = 2) %>%
  kable_styling()
```


```{r}
mean_K_I_S_agegroups <-
  dados_hemi_v1_agegroups %>% group_by(Diagnostic, Age_interval10) %>% summarise(
    # mean.T = mean(logAvgThickness, na.rm = TRUE),
    # SD_T = sd(logAvgThickness, na.rm = TRUE),
    mean.K = mean(Knorm, na.rm = TRUE),
    SD_K = sd(Knorm, na.rm = TRUE),
    mean.I = mean(Inorm, na.rm = TRUE),
    SD_I = sd(Inorm, na.rm = TRUE),
    mean.S = mean(Snorm, na.rm = TRUE),
    SD_S = sd(Snorm, na.rm = TRUE),
    N_SUBJ = n_distinct(SUBJ)
  )

write.csv(mean_K_I_S_agegroups, "datafig3.csv")

```

```{r}
fig3b <- ggplot(mean_K_I_S_agegroups, aes(x = mean.K, y = mean.S, color = Diagnostic, shape = Age_interval10))+
    geom_point() +
    geom_line(aes(group = Diagnostic)) +
    #geom_text(aes(label=Age.group), nudge_y = 0.1, size =3)+
    theme_pubr() + 
  # guides(color = "none") + 
    labs(shape = "Age", x = "K (normalized)", y = "S (normalized)") +
    # theme(axis.title = element_text(size = 11),
    #       axis.text = element_text(size = 10), text = element_text(size = 10)) +
  scale_fill_manual(values=cbbPalette2) +
  scale_colour_manual(values=cbbPalette2) +
  theme(legend.position="bottom", legend.box="vertical", legend.margin=margin())

fig3b

```

```{r}
fig3b_Alt <- ggplot(mean_K_I_S_agegroups, aes(x = mean.K, y = mean.S, color = Diagnostic, shape = Age_interval10))+
    geom_point() +
    geom_line(aes(group = Diagnostic)) +
  geom_errorbar(aes(ymin = mean.S - SD_S, ymax = mean.S + SD_S))  +
  geom_errorbarh(aes(xmin = mean.K - SD_K, xmax = mean.K + SD_K))  +
  geom_point(data = dados_hemi_v1_agegroups, aes(x = Knorm, y = Snorm, color = Diagnostic, shape = Age_interval10), alpha = 0.2) +
    #geom_text(aes(label=Age.group), nudge_y = 0.1, size =3)+
    theme_pubr() + 
  # guides(color = "none") + 
    labs(shape = "Age", x = "K (normalized)", y = "S (normalized)") +
    # theme(axis.title = element_text(size = 11),
    #       axis.text = element_text(size = 10), text = element_text(size = 10)) +
  scale_fill_manual(values=cbbPalette2) +
  scale_colour_manual(values=cbbPalette2) +
  theme(legend.position="bottom", legend.box="vertical", legend.margin=margin())

fig3b_Alt
```

```{r}
fig3d <- ggplot(mean_K_I_S_agegroups, aes(x = mean.K, y = mean.I, color = Diagnostic, shape = Age_interval10))+
    geom_point() +
    geom_line(aes(group = Diagnostic)) +
    #geom_text(aes(label=Age.group), nudge_y = 0.1, size =3)+
    theme_pubr() +
  # guides(color = "none") + 
    labs(shape = "Age", x = "K (normalized)", y = "I (normalized)")  +
    # theme(axis.title = element_text(size = 11),
    #       axis.text = element_text(size = 10), text = element_text(size = 10)) +
  scale_fill_manual(values=cbbPalette2) +
  scale_colour_manual(values=cbbPalette2) +
  theme(legend.position="bottom" , legend.box="vertical", legend.margin=margin())

fig3d

```

```{r}
fig3d_Alt <- ggplot(mean_K_I_S_agegroups, aes(x = mean.K, y = mean.I, color = Diagnostic, shape = Age_interval10))+
    geom_point() +
    geom_line(aes(group = Diagnostic)) +
    geom_errorbar(aes(ymin = mean.I - SD_I, ymax = mean.I + SD_I))  +
  geom_errorbarh(aes(xmin = mean.K - SD_K, xmax = mean.K + SD_K))  +
  geom_point(data = dados_hemi_v1_agegroups, aes(x = Knorm, y = Inorm, color = Diagnostic, shape = Age_interval10), alpha = 0.2) +
    #geom_text(aes(label=Age.group), nudge_y = 0.1, size =3)+
    theme_pubr() + 
  # guides(color = "none") + 
    labs(shape = "Age", x = "K (normalized)", y = "I (normalized)") +
    # theme(axis.title = element_text(size = 11),
    #       axis.text = element_text(size = 10), text = element_text(size = 10)) +
  scale_fill_manual(values=cbbPalette2) +
  scale_colour_manual(values=cbbPalette2) +
  theme(legend.position="bottom", legend.box="vertical", legend.margin=margin())
fig3d_Alt
```

```{r}
fig3s <- ggarrange(fig3b, fig3d, labels = c("A", "B"), nrow=2, font.label = list(size = 11), common.legend = TRUE, legend = "bottom")

fig3s
```


```{r}
fig3s_Alt_allgroups <- ggarrange(fig3b_Alt, fig3d_Alt, labels = c("A", "B"),ncol = 2, nrow=1, font.label = list(size = 11), common.legend = TRUE, legend = "bottom")

fig3s_Alt_allgroups

ggsave("fig3s_Alt_allgroups.png",fig3s_Alt_allgroups, width = 18, height = 9, units = "cm", device = "png")
```

### FIGURE 3 with age intervals - age corrected

```{r}
mean_K_I_S_agegroups <-
  filter(dados_hemi_v1_agegroups) %>% group_by(Diagnostic, Age_interval10) %>% summarise(
    mean.T = mean(logAvgThickness, na.rm = TRUE),
    SD_T = sd(logAvgThickness, na.rm = TRUE),
    mean.K = mean(K_age_decay/ sqrt(1 + (1 / 4) ^ 2 + (5 / 4) ^ 2), na.rm = TRUE),
    SD_K = sd(K_age_decay/ sqrt(1 + (1 / 4) ^ 2 + (5 / 4) ^ 2), na.rm = TRUE),
    mean.I = mean(I_age_decay/ sqrt(1 ^ 2 + 1 ^ 2 + 1 ^ 1), na.rm = TRUE),
    SD_I = sd(I_age_decay/ sqrt(1 ^ 2 + 1 ^ 2 + 1 ^ 1), na.rm = TRUE),
    mean.S = mean(S_age_decay/ sqrt((3 / 2) ^ 2 + (3 / 4) ^ 2 + (9 / 4) ^ 2), na.rm = TRUE),
    SD_S = sd(S_age_decay/ sqrt((3 / 2) ^ 2 + (3 / 4) ^ 2 + (9 / 4) ^ 2), na.rm = TRUE),
    N_SUBJ = n_distinct(SUBJ)
  )
```

```{r}
fig3b <- ggplot(mean_K_I_S_agegroups, aes(x = mean.K, y = mean.S, color = Diagnostic, shape = Age_interval10))+
    geom_point() +
    geom_line(aes(group = Diagnostic)) +
    #geom_text(aes(label=Age.group), nudge_y = 0.1, size =3)+
    theme_pubr() + 
  # guides(color = "none") + 
    labs(shape = "Age", x = "K (normalized)", y = "S (normalized)") +
    # theme(axis.title = element_text(size = 11),
    #       axis.text = element_text(size = 10), text = element_text(size = 10)) +
  scale_fill_manual(values=cbbPalette2) +
  scale_colour_manual(values=cbbPalette2) +
  theme(legend.position="bottom", legend.box="vertical", legend.margin=margin())

fig3b

```

```{r}
fig3b_Alt <- ggplot(mean_K_I_S_agegroups, aes(x = mean.K, y = mean.S, color = Diagnostic, shape = Age_interval10))+
    geom_point() +
    geom_line(aes(group = Diagnostic)) +
  geom_errorbar(aes(ymin = mean.S - SD_S, ymax = mean.S + SD_S))  +
  geom_errorbarh(aes(xmin = mean.K - SD_K, xmax = mean.K + SD_K))  +
  geom_point(data = dados_hemi_v1_agegroups, aes(x = Knorm, y = Snorm, color = Diagnostic, shape = Age_interval10), alpha = 0.2) +
    #geom_text(aes(label=Age.group), nudge_y = 0.1, size =3)+
    theme_pubr() + 
  # guides(color = "none") + 
    labs(shape = "Age", x = "K (normalized)", y = "S (normalized)") +
    # theme(axis.title = element_text(size = 11),
    #       axis.text = element_text(size = 10), text = element_text(size = 10)) +
  scale_fill_manual(values=cbbPalette2) +
  scale_colour_manual(values=cbbPalette2) +
  theme(legend.position="bottom", legend.box="vertical", legend.margin=margin())

fig3b_Alt
```

```{r}
fig3d <- ggplot(mean_K_I_S_agegroups, aes(x = mean.K, y = mean.I, color = Diagnostic, shape = Age_interval10))+
    geom_point() +
    geom_line(aes(group = Diagnostic)) +
    #geom_text(aes(label=Age.group), nudge_y = 0.1, size =3)+
    theme_pubr() +
  # guides(color = "none") + 
    labs(shape = "Age", x = "K (normalized)", y = "I (normalized)")  +
    # theme(axis.title = element_text(size = 11),
    #       axis.text = element_text(size = 10), text = element_text(size = 10)) +
  scale_fill_manual(values=cbbPalette2) +
  scale_colour_manual(values=cbbPalette2) +
  theme(legend.position="bottom" , legend.box="vertical", legend.margin=margin())

fig3d

```

```{r}
fig3d_Alt <- ggplot(mean_K_I_S_agegroups, aes(x = mean.K, y = mean.I, color = Diagnostic, shape = Age_interval10))+
    geom_point() +
    geom_line(aes(group = Diagnostic)) +
    geom_errorbar(aes(ymin = mean.I - SD_I, ymax = mean.I + SD_I))  +
  geom_errorbarh(aes(xmin = mean.K - SD_K, xmax = mean.K + SD_K))  +
  geom_point(data = dados_hemi_v1_agegroups, aes(x = Knorm, y = Inorm, color = Diagnostic, shape = Age_interval10), alpha = 0.2) +
    #geom_text(aes(label=Age.group), nudge_y = 0.1, size =3)+
    theme_pubr() + 
  # guides(color = "none") + 
    labs(shape = "Age", x = "K (normalized)", y = "I (normalized)") +
    # theme(axis.title = element_text(size = 11),
    #       axis.text = element_text(size = 10), text = element_text(size = 10)) +
  scale_fill_manual(values=cbbPalette2) +
  scale_colour_manual(values=cbbPalette2) +
  theme(legend.position="bottom", legend.box="vertical", legend.margin=margin())
fig3d_Alt
```

```{r}
fig3s <- ggarrange(fig3b, fig3d, labels = c("A", "B"), nrow=2, font.label = list(size = 11), common.legend = TRUE, legend = "bottom")

fig3s
```

```{r}
fig3s_Alt <- ggarrange(fig3b_Alt, fig3d_Alt, labels = c("A", "B"),ncol = 2, nrow=1, font.label = list(size = 11), common.legend = TRUE, legend = "bottom")

fig3s_Alt
```

```{r eval=FALSE, include=FALSE}

ggplot(dados_hemi_v1, aes(x = Diagnostic, y = S, color = Diagnostic, fill = Diagnostic, alpha = 0.4)) +
  geom_boxplot() +
 stat_compare_means(method = "anova") +
  theme_pubr() +
  scale_fill_manual(values=cbbPalette2) +
  scale_colour_manual(values=cbbPalette2)

aov_diag_S <- aov(S ~ Diagnostic, data = dados_hemi_v1)
summary(aov_diag_S)
aov_diag_S_diag_TK <- TukeyHSD(aov_diag_S)
#aov_diag_S_diag_TK

aov_diag_S_diag_TK_t <- mutate(as.data.frame(aov_diag_S_diag_TK$Diagnostic), Contrast = c("MCI-AD", "CTL-AD", "CTL-MCI") , morphological_parameter = "S", Age_correction = "no", ROI = "hemisphere")

ggplot(dados_hemi_v1, aes(x = Diagnostic, y = S_age_decay, color = Diagnostic, fill = Diagnostic, alpha = 0.4)) +
  geom_boxplot() +
 stat_compare_means(method = "anova") +
  theme_pubr() +
  scale_fill_manual(values=cbbPalette2) +
  scale_colour_manual(values=cbbPalette2)

aov_diag_S_age_decay <- aov(S_age_decay ~ Diagnostic, data = dados_hemi_v1)
summary(aov_diag_S_age_decay)
aov_diag_S_age_decay_diag_TK <- TukeyHSD(aov_diag_S_age_decay)
#aov_diag_S_age_decay_diag_TK

aov_diag_S_age_decay_diag_TK_t <- mutate(as.data.frame(aov_diag_S_age_decay_diag_TK$Diagnostic), Contrast = c("MCI-AD", "CTL-AD", "CTL-MCI") , morphological_parameter = "S", Age_correction = "yes", ROI = "hemisphere")

```

## Behavioral and CSF data correlation

```{r clinical data summary, messAge=FALSE, warning=FALSE}
#hemisphere
dados_hemi_v1_CD <- dados_hemi_v1 %>%
  pivot_longer(
    c(
      COGNITIVE_INDEX,
      `A7/A5`,
      `TMT B-A`,
      `DIGIT SPAN BACK`,
      `AB1-40`,
      `AB1-42`,
      TAU,
      AB1_ratio,
      TAU_AB1_42_ratio,
      TAU_AB1_ratio,
      Lipoxina
    ),
    names_to = "clinical_test",
    values_to = "clinical_test_value"
  ) %>%
  pivot_longer(
    c(K, K_age_decay, logAvgThickness, logAvgThickness_age_decay),
    names_to = "morphological_parameter",
    values_to = "morphological_parameter_value")

dados_hemi_v1_CD_behaviour <-
  unique(
    filter(
      dados_hemi_v1_CD,
      clinical_test == "A7/A5" |
        clinical_test == "COGNITIVE_INDEX" |
        clinical_test == "TMT B-A" | clinical_test == "DIGIT SPAN BACK"
    )
  )

dados_hemi_v1_CD_biochq <-
  unique(
    filter(
      dados_hemi_v1_CD,
      clinical_test == "AB1-40" |
        clinical_test == "AB1-42" |
        clinical_test == "TAU" |
        clinical_test == "AB1_ratio" |
        clinical_test == "TAU_AB1_42_ratio" |
        clinical_test == "TAU_AB1_ratio" | clinical_test == "Lipoxina"
    )
  )
```

```{r}
#frontal lobe
dados_lobos_v1_F_CD_behaviour <- filter(dados_lobos_v1, ROI == "F") %>%
  pivot_longer(
    c(
      `TMT B-A`,
      `DIGIT SPAN BACK`
    ),
    names_to = "clinical_test",
    values_to = "clinical_test_value"
  ) %>%
  pivot_longer(
    c(
      K_corrected,
      K_age_decay,
      logAvgThickness,
      logAvgThickness_age_decay
    ),
    names_to = "morphological_parameter",
    values_to = "morphological_parameter_value"
  )
```

```{r}
#temporal lobe
dados_lobos_v1_T_CD_behaviour <- filter(dados_lobos_v1, ROI == "T") %>%
  pivot_longer(
    c(
      `A7/A5`,
    ),
    names_to = "clinical_test",
    values_to = "clinical_test_value"
  ) %>%
  pivot_longer(
    c(
      K_corrected,
      K_age_decay,
      logAvgThickness,
      logAvgThickness_age_decay
    ),
    names_to = "morphological_parameter",
    values_to = "morphological_parameter_value"
  )
```

### Summary
```{r}
dados_hemi_v1 %>%
group_by(Diagnostic) %>%
summarise(
N = n_distinct(SUBJ),
Mean_COGNITIVE_INDEX = mean(COGNITIVE_INDEX,  na.rm = TRUE),
STD_COGNITIVE_INDEX = sd(COGNITIVE_INDEX,  na.rm = TRUE),
Mean_A7_A5 = mean(`A7/A5`,  na.rm = TRUE),
STD_A7_A5 = sd(`A7/A5`,  na.rm = TRUE),
Mean_TMT_B_A = mean(`TMT B-A`,  na.rm = TRUE),
STD_TMT_B_A = sd(`TMT B-A`,  na.rm = TRUE),
Mean_DIGIT_SPAN_BACK = mean(`DIGIT SPAN BACK`,  na.rm = TRUE),
STD_DIGIT_SPAN_BACK = sd(`DIGIT SPAN BACK`,  na.rm = TRUE),
Mean_Lipoxina = mean(Lipoxina ,  na.rm = TRUE),
STD_Lipoxina = sd(Lipoxina ,  na.rm = TRUE),
Mean_AB1_40 = mean(`AB1-40`,  na.rm = TRUE),
STD_AB1_40 = sd(`AB1-40`,  na.rm = TRUE),
Mean_AB1_42 = mean(`AB1-42`,  na.rm = TRUE),
STD_AB1_42 = sd(`AB1-42`,  na.rm = TRUE),
Mean_TAU = mean(TAU,  na.rm = TRUE),
STD_TAU = sd(TAU,  na.rm = TRUE)) %>%
  kable(digits = 2) %>%
  kable_styling() %>%
  column_spec(1, width = "10cm")
```

```{r}
dados_hemi_v1_CD %>%
group_by(clinical_test, Diagnostic) %>%
summarise(
N = n_distinct(SUBJ),
Mean = mean(clinical_test_value,  na.rm = TRUE),
STD = sd(clinical_test_value,  na.rm = TRUE)) %>%
  kable(digits = 2) %>%
  kable_styling()
```

### Hemisphere

```{r, echo=FALSE}

Corr1 <- dados_hemi_v1_CD_behaviour %>%
  group_by(morphological_parameter, clinical_test) %>%
  summarise(
    t = signif(
      cor.test(
        morphological_parameter_value,
        clinical_test_value,
        use = "complete",
        method = "pearson"
      )$statistic,
      2
    ),
    df =  signif(
      cor.test(
        morphological_parameter_value,
        clinical_test_value,
        use = "complete",
        method = "pearson"
      )$parameter,
      2
    ),
    Correlation = signif(
      cor.test(
        morphological_parameter_value,
        clinical_test_value,
        use = "complete",
        method = "pearson"
      )$estimate,
      2
    ),
    pvalue = signif(
      cor.test(
        morphological_parameter_value,
        clinical_test_value,
        use = "complete",
        method = "pearson"
      )$p.value,
      4)
    ,
    eff.size = signif(
      res(
        Correlation,
        var.r = NULL,
        (df + 2) / 2,
        level = 95,
        dig = 2,
        verbose = FALSE
      )$d,
      2
    )
  ) %>%
  mutate(
    Diagnostic = "All",
    ROI = "Hemisphere",
    kind = "behaviour",
    Age_correction = ifelse(
      str_detect(morphological_parameter, "_age_decay", negate = FALSE),
      "yes",
      "no"
    )
  ) 
```

```{r}
Corr2 <- dados_hemi_v1_CD_biochq %>%
  group_by(morphological_parameter, clinical_test) %>%
  summarise(
    t = signif(
      cor.test(
        morphological_parameter_value,
        clinical_test_value,
        use = "complete",
        method = "pearson"
      )$statistic,
      2
    ),
    df =  signif(
      cor.test(
        morphological_parameter_value,
        clinical_test_value,
        use = "complete",
        method = "pearson"
      )$parameter,
      2
    ),
    Correlation = signif(
      cor.test(
        morphological_parameter_value,
        clinical_test_value,
        use = "complete",
        method = "pearson"
      )$estimate,
      2
    ),
    pvalue = signif(
      cor.test(
        morphological_parameter_value,
        clinical_test_value,
        use = "complete",
        method = "pearson"
      )$p.value,
      4
    )
    ,
    eff.size = signif(
      res(
        Correlation,
        var.r = NULL,
        (df + 2) / 2,
        level = 95,
        dig = 2,
        verbose = FALSE
      )$d,
      2
    )
  ) %>%
  mutate(
    Diagnostic = "All",
    ROI = "Hemisphere",
    kind = "behaviour",
    Age_correction = ifelse(
      str_detect(morphological_parameter, "_age_decay", negate = FALSE),
      "yes",
      "no"
    )
  )


```

### Frontal

```{r corr cov lobo frontal ,include=FALSE}

Corr3 <- dados_lobos_v1_F_CD_behaviour %>%
  group_by(morphological_parameter, clinical_test) %>%
  summarise(
    t = signif(
      cor.test(
        morphological_parameter_value,
        clinical_test_value,
        use = "complete",
        method = "pearson"
      )$statistic,
      2
    ),
    df =  signif(
      cor.test(
        morphological_parameter_value,
        clinical_test_value,
        use = "complete",
        method = "pearson"
      )$parameter,
      2
    ),
    Correlation = signif(
      cor.test(
        morphological_parameter_value,
        clinical_test_value,
        use = "complete",
        method = "pearson"
      )$estimate,
      2
    ),
    pvalue = signif(
      cor.test(
        morphological_parameter_value,
        clinical_test_value,
        use = "complete",
        method = "pearson"
      )$p.value,
      4
    )
    ,
    eff.size = signif(
      res(
        Correlation,
        var.r = NULL,
        (df + 2) / 2,
        level = 95,
        dig = 2,
        verbose = FALSE
      )$d,
      2
    )
  ) %>%
  mutate(
    Diagnostic = "All",
    ROI = "Frontal lobe",
    kind = "behaviour",
    Age_correction = ifelse(
      str_detect(morphological_parameter, "_age_decay", negate = FALSE),
      "yes",
      "no"
    )
  )
```

### Temporal

```{r corr cov lobo temporal ,include=FALSE}
Corr4 <- dados_lobos_v1_T_CD_behaviour %>%
  group_by(morphological_parameter, clinical_test) %>%
  summarise(
    t = signif(
      cor.test(
        morphological_parameter_value,
        clinical_test_value,
        use = "complete",
        method = "pearson"
      )$statistic,
      2
    ),
    df =  signif(
      cor.test(
        morphological_parameter_value,
        clinical_test_value,
        use = "complete",
        method = "pearson"
      )$parameter,
      2
    ),
    Correlation = signif(
      cor.test(
        morphological_parameter_value,
        clinical_test_value,
        use = "complete",
        method = "pearson"
      )$estimate,
      2
    ),
    pvalue = signif(
      cor.test(
        morphological_parameter_value,
        clinical_test_value,
        use = "complete",
        method = "pearson"
      )$p.value,
      4
    )
    ,
    eff.size = signif(
      res(
        Correlation,
        var.r = NULL,
        (df + 2) / 2,
        level = 95,
        dig = 2,
        verbose = FALSE
      )$d,
      2
    )
  ) %>%
  mutate(
    Diagnostic = "All",
    ROI = "Temporal lobe",
    kind = "behaviour",
    Age_correction = ifelse(
      str_detect(morphological_parameter, "_age_decay", negate = FALSE),
      "yes",
      "no"
    )
  )

```

```{r}
Corr_all <- full_join(Corr1, Corr2) %>%
  full_join(Corr3) %>%
  full_join(Corr4)

Corr_all$morphological_parameter[Corr_all$morphological_parameter == "K_corrected"] <- "K"
Corr_all$morphological_parameter[Corr_all$morphological_parameter == "K_age_decay"] <- "K"
Corr_all$morphological_parameter[Corr_all$morphological_parameter == "logAvgThickness_age_decay"] <- "logAvgThickness"

Corr_all <- Corr_all %>%
  group_by(morphological_parameter, clinical_test) %>%
  mutate(pval.adj = p.adjust(pvalue, method = 'bonferroni'))
```

**Table 2**
## Raw
 
```{r}
Corr_all %>%
  filter(Age_correction == "no") %>%
  # dplyr::select(-c(pvalue)) %>%
  kable(digits = 3) %>%
  kable_styling()
```
 
## Age corrected

```{r}
Corr_all %>%
  filter(Age_correction == "yes") %>%
  # dplyr::select(-c(pvalue)) %>%
  kable(digits = 3) %>%
  kable_styling()
```
